<!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><i><font color="#9A1900">/* </font></i>
<i><font color="#9A1900">   Copyright (C) 2019-2021 Magnusson Institute, All Rights Reserved</font></i>

<i><font color="#9A1900">   "Snackabra" is a registered trademark</font></i>

<i><font color="#9A1900">   This program is free software: you can redistribute it and/or</font></i>
<i><font color="#9A1900">   modify it under the terms of the GNU Affero General Public License</font></i>
<i><font color="#9A1900">   as published by the Free Software Foundation, either version 3 of</font></i>
<i><font color="#9A1900">   the License, or (at your option) any later version.</font></i>

<i><font color="#9A1900">   This program is distributed in the hope that it will be useful, but</font></i>
<i><font color="#9A1900">   WITHOUT ANY WARRANTY; without even the implied warranty of</font></i>
<i><font color="#9A1900">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font></i>
<i><font color="#9A1900">   Affero General Public License for more details.</font></i>

<i><font color="#9A1900">   You should have received a copy of the GNU Affero General Public</font></i>
<i><font color="#9A1900">   License along with this program.  If not, see www.gnu.org/licenses/</font></i>

<i><font color="#9A1900">*/</font></i>


async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleErrors</font></b><font color="#990000">(</font>request<font color="#990000">,</font> func<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> await <b><font color="#000000">func</font></b><font color="#990000">();</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Upgrade"</font><font color="#990000">)</font> <font color="#990000">==</font> <font color="#FF0000">"websocket"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      let pair <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">WebSocketPair</font></b><font color="#990000">();</font>
      pair<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">].</font><b><font color="#000000">accept</font></b><font color="#990000">();</font>
      pair<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">].</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'[handleErrors()] '</font> <font color="#990000">+</font> err<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font>  err<font color="#990000">.</font>stack  <font color="#FF0000">}</font><font color="#990000">));</font>
      pair<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">].</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#993399">1011</font><font color="#990000">,</font> <font color="#FF0000">"Uncaught exception during session setup"</font><font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font><b><font color="#0000FF">null</font></b><font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">101</font><font color="#990000">,</font> webSocket<font color="#990000">:</font> pair<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> err<font color="#990000">.</font>stack<font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">)</font>
      <i><font color="#9A1900">//return new Response(err.stack, { status: 500 });</font></i>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// so many problems with JSON parsing, adding a wrapper to capture more info</font></i>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>str<font color="#990000">,</font> loc<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>str<font color="#990000">);</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// sometimes it's an embedded string</font></i>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font><b><font color="#000000">eval</font></b><font color="#990000">(</font>str<font color="#990000">));</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// let's try one more thing</font></i>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>str<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#FF0000">{</font>
	  <i><font color="#9A1900">// we'll throw the original error</font></i>
	  <b><font color="#0000FF">throw</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">'JSON.parse() error at '</font> <font color="#990000">+</font> loc <font color="#990000">+</font> <font color="#FF0000">' (tried eval and slice): '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">String was: '</font> <font color="#990000">+</font> str<font color="#990000">);</font>
	<font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>


<b><font color="#0000FF">function</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> contents<font color="#990000">,</font> s<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
    <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type, authorization"</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Credentials"</font><font color="#990000">:</font> <font color="#FF0000">"true"</font><font color="#990000">,</font>
    <font color="#FF0000">'Content-Type'</font><font color="#990000">:</font> <font color="#FF0000">'application/json;'</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">),</font>
  <font color="#FF0000">}</font>
  <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>contents<font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> s<font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">export</font></b> <b><font color="#0000FF">default</font></b> <font color="#FF0000">{</font>
  async <b><font color="#000000">fetch</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleErrors</font></b><font color="#990000">(</font>request<font color="#990000">,</font> <b><font color="#000000">async</font></b> <font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>

      let url <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      let path <font color="#990000">=</font> url<font color="#990000">.</font>pathname<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">).</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'/'</font><font color="#990000">);</font>

      <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>path<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">])</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"api"</font><font color="#990000">:</font>
          <i><font color="#9A1900">// This is a request for `/api/...`, call the API handler.</font></i>
          <b><font color="#0000FF">return</font></b> <b><font color="#000000">handleApiRequest</font></b><font color="#990000">(</font>path<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">),</font> request<font color="#990000">,</font> env<font color="#990000">);</font>

        <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Not found"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">)</font>
        <i><font color="#9A1900">//return new Response("Not found", { status: 404 });</font></i>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>


async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleApiRequest</font></b><font color="#990000">(</font>path<font color="#990000">,</font> request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <i><font color="#9A1900">// We've received at API request. Route the request based on the path.</font></i>

  <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>path<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">])</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">case</font></b> <font color="#FF0000">"room"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// Request for `/api/room/...`.</font></i>

      <i><font color="#9A1900">// OK, the request is for `/api/room/&lt;name&gt;/...`. It's time to route to the Durable Object</font></i>
      <i><font color="#9A1900">// for the specific room.</font></i>
      let name <font color="#990000">=</font> path<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">];</font>

      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font><font color="#FF0000">"https://m063.dpn.workers.dev/api/v1/pubKeys?roomId="</font> <font color="#990000">+</font> name<font color="#990000">).</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Not found"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
      let id <font color="#990000">=</font> env<font color="#990000">.</font>rooms<font color="#990000">.</font><b><font color="#000000">idFromName</font></b><font color="#990000">(</font>name<font color="#990000">);</font>

      let roomObject <font color="#990000">=</font> env<font color="#990000">.</font>rooms<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>id<font color="#990000">);</font>
      let newUrl <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      newUrl<font color="#990000">.</font>pathname <font color="#990000">=</font> <font color="#FF0000">"/"</font> <font color="#990000">+</font> path<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">).</font><b><font color="#000000">join</font></b><font color="#990000">(</font><font color="#FF0000">"/"</font><font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> roomObject<font color="#990000">.</font><b><font color="#000000">fetch</font></b><font color="#990000">(</font>newUrl<font color="#990000">,</font> request<font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">case</font></b> <font color="#FF0000">"notifications"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
      let reqData <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
      let roomList <font color="#990000">=</font> reqData<font color="#990000">.</font>rooms<font color="#990000">;</font>
      let deviceIdentifier <font color="#990000">=</font> reqData<font color="#990000">.</font>identifier<font color="#990000">;</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Registering notifications"</font><font color="#990000">,</font> roomList<font color="#990000">,</font> deviceIdentifier<font color="#990000">)</font>
      <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> roomList<font color="#990000">.</font>length<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"In loop"</font><font color="#990000">);</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"ROOM ID"</font><font color="#990000">,</font> roomList<font color="#990000">[</font>i<font color="#990000">])</font>
        let id <font color="#990000">=</font> env<font color="#990000">.</font>rooms<font color="#990000">.</font><b><font color="#000000">idFromName</font></b><font color="#990000">(</font>roomList<font color="#990000">[</font>i<font color="#990000">]);</font>

        let roomObject <font color="#990000">=</font> env<font color="#990000">.</font>rooms<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>id<font color="#990000">);</font>
        let newUrl <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
        newUrl<font color="#990000">.</font>pathname <font color="#990000">=</font> <font color="#FF0000">"/"</font> <font color="#990000">+</font> roomList<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">+</font> <font color="#FF0000">"/registerDevice"</font><font color="#990000">;</font>
        newUrl<font color="#990000">.</font>searchParams<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font><font color="#FF0000">"id"</font><font color="#990000">,</font> deviceIdentifier<font color="#990000">)</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"URL for room"</font><font color="#990000">,</font> newUrl<font color="#990000">)</font>
        roomObject<font color="#990000">.</font><b><font color="#000000">fetch</font></b><font color="#990000">(</font>newUrl<font color="#990000">,</font> request<font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#FF0000">"Successfully received"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">case</font></b> <font color="#FF0000">"getLastMessageTimes"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> _rooms <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
        let lastMessageTimes <font color="#990000">=</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
        <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> _rooms<font color="#990000">.</font>length<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
          lastMessageTimes<font color="#990000">[</font>_rooms<font color="#990000">[</font>i<font color="#990000">]]</font> <font color="#990000">=</font> await <b><font color="#000000">lastTimeStamp</font></b><font color="#990000">(</font>_rooms<font color="#990000">[</font>i<font color="#990000">],</font> env<font color="#990000">);</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>lastMessageTimes<font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'[getLastMessageTimes] '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Not found"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">)</font>
    <i><font color="#9A1900">//return new Response("Not found", { status: 404 });</font></i>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">lastTimeStamp</font></b><font color="#990000">(</font>room_id<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    let list_response <font color="#990000">=</font> await env<font color="#990000">.</font>MESSAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">(</font><font color="#FF0000">{</font> <font color="#FF0000">"prefix"</font><font color="#990000">:</font> room_id <font color="#FF0000">}</font><font color="#990000">);</font>
    <i><font color="#9A1900">// console.log('Here')</font></i>
    let message_keys <font color="#990000">=</font> list_response<font color="#990000">.</font>keys<font color="#990000">.</font><b><font color="#000000">map</font></b><font color="#990000">((</font>res<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> res<font color="#990000">.</font>name <font color="#FF0000">}</font><font color="#990000">);</font>
    <b><font color="#0000FF">while</font></b> <font color="#990000">(!</font>list_response<font color="#990000">.</font>list_complete<font color="#990000">)</font> <font color="#FF0000">{</font>
      list_response <font color="#990000">=</font> await env<font color="#990000">.</font>MESSAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">(</font><font color="#FF0000">{</font> <font color="#FF0000">"cursor"</font><font color="#990000">:</font> list_response<font color="#990000">.</font>cursor <font color="#FF0000">}</font><font color="#990000">)</font>
      message_keys <font color="#990000">=</font> <font color="#990000">[...</font>message_keys<font color="#990000">,</font> list_response<font color="#990000">.</font>keys<font color="#990000">];</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> message_keys<font color="#990000">[</font>message_keys<font color="#990000">.</font>length <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">].</font><b><font color="#000000">slice</font></b><font color="#990000">(</font>room_id<font color="#990000">.</font>length<font color="#990000">);</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <font color="#FF0000">'0'</font><font color="#990000">;</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// =======================================================================================</font></i>
<i><font color="#9A1900">// The ChatRoom Durable Object Class</font></i>
<i><font color="#9A1900">//</font></i>
<i><font color="#9A1900">// ChatRoom implements a Durable Object that coordinates an individual</font></i>
<i><font color="#9A1900">// chat room. Participants connect to the room using WebSockets, and</font></i>
<i><font color="#9A1900">// the room broadcasts messages from each participant to all others.</font></i>
<i><font color="#9A1900">//</font></i>
<b><font color="#0000FF">export</font></b> <b><font color="#0000FF">class</font></b> ChatRoomAPI <font color="#FF0000">{</font>
  <b><font color="#000000">constructor</font></b><font color="#990000">(</font>state<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage <font color="#990000">=</font> state<font color="#990000">.</font>storage<font color="#990000">;</font>

    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env <font color="#990000">=</font> env<font color="#990000">;</font>

    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>sessions <font color="#990000">=</font> <font color="#990000">[];</font>

    <i><font color="#9A1900">// We keep track of the last-seen message's timestamp just so that we can assign monotonically</font></i>
    <i><font color="#9A1900">// increasing timestamps even if multiple messages arrive simultaneously (see below).</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lastTimestamp <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity <font color="#990000">=</font> <font color="#993399">20</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors <font color="#990000">=</font> <font color="#990000">[];</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ownerUnread <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>encryptionKey <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys <font color="#990000">=</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests <font color="#990000">=</font> <font color="#990000">[];</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests <font color="#990000">=</font> <font color="#990000">[];</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>motd <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>signKey <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storageLimit <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ledgerKey <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds <font color="#990000">=</font> <font color="#990000">[];</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>claimIat <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>notificationToken <font color="#990000">=</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>personalRoom <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <i><font color="#9A1900">// need the initialize method to restore state of room when the worker is updated</font></i>

  async <b><font color="#000000">initialize</font></b><font color="#990000">(</font>room_id<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> storage <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lastTimestamp <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'lastTimestamp'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">=</font> room_id<font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>personalRoom <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'personalRoom'</font><font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <i><font color="#9A1900">// this.room_owner = await storage.get('room_owner');</font></i>
    <i><font color="#9A1900">// this.encryptionKey = await storage.get('encryptionKey');</font></i>
    <i><font color="#9A1900">/*if (typeof this.room_owner === 'undefined' || typeof this.encryptionKey === 'undefined') {</font></i>
<i><font color="#9A1900">      const keyFetch_json = await fetch("</font></i><u><font color="#0000FF">https://m063.dpn.workers.dev/api/v1/pubKeys</font></u><i><font color="#9A1900">?roomId=" + this.room_id)</font></i>
<i><font color="#9A1900">      this.room_owner = JSON.stringify(keyFetch_json.ownerKey);</font></i>
<i><font color="#9A1900">      this.encryptionKey = JSON.stringify(keyFetch_json.encryptionKey);</font></i>
<i><font color="#9A1900">    }*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'ownerKey'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'guestKey'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>signKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'signKey'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>encryptionKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'encryptionKey'</font><font color="#990000">);</font>
    let ledgerKeyString <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'ledgerKey'</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>ledgerKeyString <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font> ledgerKeyString <font color="#990000">!==</font> <font color="#FF0000">""</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ledgerKey <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>ledgerKeyString<font color="#990000">,</font> <font color="#FF0000">'L217'</font><font color="#990000">),</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"RSA-OAEP"</font><font color="#990000">,</font> hash<font color="#990000">:</font> <font color="#FF0000">'SHA-256'</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">])</font> <font color="#990000">||</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'room_capacity'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#993399">20</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'visitors'</font><font color="#990000">)</font> <font color="#990000">||</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">([]),</font> <font color="#FF0000">'L220'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ownerUnread <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'ownerUnread'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'locked'</font><font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'join_requests'</font><font color="#990000">)</font> <font color="#990000">||</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">([]),</font> <font color="#FF0000">'L223'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'accepted_requests'</font><font color="#990000">)</font> <font color="#990000">||</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">([]),</font> <font color="#FF0000">'L224'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storageLimit <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'storageLimit'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#993399">1024</font> <font color="#990000">*</font> <font color="#993399">1024</font> <font color="#990000">*</font> <font color="#993399">1024</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys <font color="#990000">=</font> <b><font color="#000000">await</font></b> <font color="#990000">(</font>storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'lockedKeys'</font><font color="#990000">))</font> <font color="#990000">||</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font><b><font color="#000000">await</font></b> <font color="#990000">(</font>storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'deviceIds'</font><font color="#990000">))</font> <font color="#990000">||</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">([]),</font> <font color="#FF0000">'L227'</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>claimIat <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'claimIat'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>notificationToken <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'notificationToken'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#FF0000">""</font><font color="#990000">;</font>
    <i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">    for (let i = 0; i &lt; this.accepted_requests.length; i++) {</font></i>
<i><font color="#9A1900">      this.lockedKeys[this.accepted_requests[i]] = await storage.get(this.accepted_requests[i]);</font></i>
<i><font color="#9A1900">    }</font></i>
<i><font color="#9A1900">    */</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>motd <font color="#990000">=</font> await storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'motd'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#FF0000">''</font><font color="#990000">;</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">fetch</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>initializePromise<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>initializePromise <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">initialize</font></b><font color="#990000">((</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">)).</font>pathname<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'/'</font><font color="#990000">)[</font><font color="#993399">1</font><font color="#990000">]);</font>
    <font color="#FF0000">}</font>
    await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>initializePromise<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest <font color="#990000">===</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'guestKey'</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleErrors</font></b><font color="#990000">(</font>request<font color="#990000">,</font> <b><font color="#000000">async</font></b> <font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      let url <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      <i><font color="#9A1900">/* if (this.room_owner === '') {</font></i>
<i><font color="#9A1900">        this.room_id = url.pathname.split('/')[1];</font></i>
<i><font color="#9A1900">        const keyFetch_json = await fetch("</font></i><u><font color="#0000FF">https://m063.dpn.workers.dev/api/v1/pubKeys</font></u><i><font color="#9A1900">?roomId=" + this.room_id)</font></i>
<i><font color="#9A1900">        this.room_owner = JSON.stringify(keyFetch_json.ownerKey);</font></i>
<i><font color="#9A1900">        this.encryptionKey = JSON.stringify(keyFetch_json.encryptionKey);</font></i>
<i><font color="#9A1900">      }*/</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">=</font> url<font color="#990000">.</font>pathname<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'/'</font><font color="#990000">)[</font><font color="#993399">1</font><font color="#990000">];</font>
      <i><font color="#9A1900">// url.pathname = "/" + url.pathname.split('/').slice(2).join("/");</font></i>
      let url_pathname <font color="#990000">=</font> <font color="#FF0000">"/"</font> <font color="#990000">+</font> url<font color="#990000">.</font>pathname<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'/'</font><font color="#990000">).</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">2</font><font color="#990000">).</font><b><font color="#000000">join</font></b><font color="#990000">(</font><font color="#FF0000">"/"</font><font color="#990000">)</font>
      let new_url <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>url<font color="#990000">.</font>origin <font color="#990000">+</font> url_pathname<font color="#990000">)</font>
      <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>new_url<font color="#990000">.</font>pathname<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/websocket"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Upgrade"</font><font color="#990000">)</font> <font color="#990000">!=</font> <font color="#FF0000">"websocket"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font><font color="#FF0000">"expected websocket"</font><font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">400</font> <font color="#FF0000">}</font><font color="#990000">);</font>
          <font color="#FF0000">}</font>
          <i><font color="#9A1900">// this.room_id = request.url;</font></i>
          let ip <font color="#990000">=</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"CF-Connecting-IP"</font><font color="#990000">);</font>
          let pair <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">WebSocketPair</font></b><font color="#990000">();</font>
          await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">handleSession</font></b><font color="#990000">(</font>pair<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">],</font> ip<font color="#990000">);</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font><b><font color="#0000FF">null</font></b><font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">101</font><font color="#990000">,</font> webSocket<font color="#990000">:</font> pair<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#FF0000">}</font><font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/oldMessages"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">handleOldMessages</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/updateRoomCapacity"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">handleRoomCapacityChange</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
          <i><font color="#9A1900">// return await this.handleRoomCapacityChange(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/getRoomCapacity"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getRoomCapacity</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
          <i><font color="#9A1900">// return await this.getRoomCapacity(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/getPubKeys"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getPubKeys</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
          <i><font color="#9A1900">// return await this.getPubKeys(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/getJoinRequests"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getJoinRequests</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
          <i><font color="#9A1900">// return await this.getJoinRequests(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/lockRoom"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">lockRoom</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
          <i><font color="#9A1900">// return await this.lockRoom(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/acceptVisitor"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">acceptVisitor</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
          <i><font color="#9A1900">// return await this.acceptVisitor(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/roomLocked"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">isRoomLocked</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
          <i><font color="#9A1900">// return await this.isRoomLocked(request);</font></i>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/ownerUnread"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getOwnerUnreadMessages</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/motd"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setMOTD</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/ownerKeyRotation"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">ownerKeyRotation</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/storageRequest"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">handleNewStorage</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/getAdminData"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">handleAdminDataRequest</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Owner verification failed"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">));</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/registerDevice"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">registerDevice</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/downloadData"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">downloadAllData</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/uploadRoom"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">uploadData</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/authorizeRoom"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">authorizeRoom</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">"/postPubKey"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">postPubKey</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Not found-"</font> <font color="#990000">+</font> new_url<font color="#990000">.</font>pathname <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">)</font>
        <i><font color="#9A1900">//return new Response("Not found", { status: 404 });</font></i>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">handleSession</font></b><font color="#990000">(</font>webSocket<font color="#990000">,</font> ip<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// await this.initialize();</font></i>
    webSocket<font color="#990000">.</font><b><font color="#000000">accept</font></b><font color="#990000">();</font>
    <i><font color="#9A1900">// Create our session and add it to the sessions list.</font></i>
    <i><font color="#9A1900">// We don't send any messages to the client until it has sent us the initial user info</font></i>
    <i><font color="#9A1900">// message which would be the client's pubKey</font></i>
    let session <font color="#990000">=</font> <font color="#FF0000">{</font> webSocket<font color="#990000">,</font> blockedMessages<font color="#990000">:</font> <font color="#990000">[]</font> <font color="#FF0000">}</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>sessions<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>session<font color="#990000">);</font>

    let storage <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">(</font><font color="#FF0000">{</font> reverse<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> limit<font color="#990000">:</font> <font color="#993399">100</font><font color="#990000">,</font> prefix<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#FF0000">}</font><font color="#990000">);</font>
    let keys <font color="#990000">=</font> <font color="#990000">[...</font>storage<font color="#990000">.</font><b><font color="#000000">keys</font></b><font color="#990000">()];</font>
    keys<font color="#990000">.</font><b><font color="#000000">reverse</font></b><font color="#990000">();</font>
    let backlog <font color="#990000">=</font> <font color="#FF0000">{}</font>
    keys<font color="#990000">.</font><b><font color="#000000">forEach</font></b><font color="#990000">(</font>key <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        backlog<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">),</font> <font color="#FF0000">'L371'</font><font color="#990000">);</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        webSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'[handleSession()] '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">));</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">)</font>
    <i><font color="#9A1900">//session.blockedMessages.push(JSON.stringify({...storage}))</font></i>
    <i><font color="#9A1900">//let backlog = [...storage.values()];</font></i>
    <i><font color="#9A1900">//backlog.reverse();</font></i>
    <i><font color="#9A1900">//backlog.forEach(value =&gt; {</font></i>
    <i><font color="#9A1900">//  session.blockedMessages.push(value);</font></i>
    <i><font color="#9A1900">//});</font></i>
    session<font color="#990000">.</font>blockedMessages <font color="#990000">=</font> <font color="#990000">[...</font>session<font color="#990000">.</font>blockedMessages<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>backlog<font color="#990000">)]</font>
    <i><font color="#9A1900">// Set event handlers to receive messages.</font></i>
    let receivedUserInfo <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    webSocket<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"message"</font><font color="#990000">,</font> async msg <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>session<font color="#990000">.</font>quit<font color="#990000">)</font> <font color="#FF0000">{</font>
          webSocket<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#993399">1011</font><font color="#990000">,</font> <font color="#FF0000">"WebSocket broken."</font><font color="#990000">);</font>
          <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>

        <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>receivedUserInfo<font color="#990000">)</font> <font color="#FF0000">{</font>
          <i><font color="#9A1900">// The first message the client sends is the user info message with their pubKey. Save it</font></i>
          <i><font color="#9A1900">// into their session object and in the visitor list.</font></i>
          <i><font color="#9A1900">// webSocket.send(JSON.stringify({error: JSON.stringify(msg)}));</font></i>
          <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>msg<font color="#990000">.</font>data<font color="#990000">,</font> <font color="#FF0000">'L396'</font><font color="#990000">);</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">===</font> <font color="#FF0000">""</font><font color="#990000">)</font> <font color="#FF0000">{</font>
            webSocket<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#993399">4000</font><font color="#990000">,</font> <font color="#FF0000">"This room does not have an owner, or the owner has not enabled it. You cannot leave messages here."</font><font color="#990000">);</font>
          <font color="#FF0000">}</font>
          let keys <font color="#990000">=</font> <font color="#FF0000">{</font> ownerKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner<font color="#990000">,</font> guestKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest<font color="#990000">,</font> encryptionKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>encryptionKey<font color="#990000">,</font> signKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>signKey <font color="#FF0000">}</font><font color="#990000">;</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font>pem<font color="#990000">)</font> <font color="#FF0000">{</font>
            keys <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">convertToPem</font></b><font color="#990000">(</font><font color="#FF0000">{</font> ownerKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner<font color="#990000">,</font> guestKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest<font color="#990000">,</font> encryptionKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>encryptionKey<font color="#990000">,</font> signKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>signKey <font color="#FF0000">}</font><font color="#990000">);</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>data<font color="#990000">.</font>name<font color="#990000">)</font> <font color="#FF0000">{</font>
            webSocket<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#993399">1000</font><font color="#990000">,</font> <font color="#FF0000">'The first message should contain the pubKey'</font><font color="#990000">)</font>
            <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
          <font color="#FF0000">}</font>
          <i><font color="#9A1900">// const isPreviousVisitor = this.visitors.indexOf(data.name) &gt; -1;</font></i>
          <i><font color="#9A1900">// const isAccepted = this.accepted_requests.indexOf(data.name) &gt; -1;</font></i>
          let _name<font color="#990000">;</font>
          <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
            _name <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>data<font color="#990000">.</font>name<font color="#990000">,</font> <font color="#FF0000">'L412'</font><font color="#990000">);</font>
          <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <font color="#FF0000">{</font>
            webSocket<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#993399">1000</font><font color="#990000">,</font> <font color="#FF0000">'The first message should contain the pubKey in json stringified format'</font><font color="#990000">)</font>
            <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">const</font></b> isPreviousVisitor <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">checkJsonExistence</font></b><font color="#990000">(</font>_name<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">);</font>
          <b><font color="#0000FF">const</font></b> isAccepted <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">checkJsonExistence</font></b><font color="#990000">(</font>_name<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests<font color="#990000">);</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>isPreviousVisitor <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">.</font>length <font color="#990000">&gt;=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity<font color="#990000">)</font> <font color="#FF0000">{</font>
            webSocket<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#993399">4000</font><font color="#990000">,</font> <font color="#FF0000">'The room is not accepting any more visitors.'</font><font color="#990000">);</font>
            <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>isPreviousVisitor<font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>data<font color="#990000">.</font>name<font color="#990000">);</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'visitors'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">))</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked<font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>isAccepted <font color="#990000">&amp;&amp;</font> <font color="#990000">!</font>isPreviousVisitor<font color="#990000">)</font> <font color="#FF0000">{</font>
              <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>data<font color="#990000">.</font>name<font color="#990000">);</font>
              <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'join_requests'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">));</font>
            <font color="#FF0000">}</font>
            <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
              <i><font color="#9A1900">// const encrypted_key = this.lockedKeys[data.name];</font></i>
              <b><font color="#0000FF">const</font></b> encrypted_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys<font color="#990000">[</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getLockedKey</font></b><font color="#990000">(</font>_name<font color="#990000">)];</font>
              keys<font color="#990000">[</font><font color="#FF0000">'locked_key'</font><font color="#990000">]</font> <font color="#990000">=</font> encrypted_key<font color="#990000">;</font>
            <font color="#FF0000">}</font>

          <font color="#FF0000">}</font>
          session<font color="#990000">.</font>name <font color="#990000">=</font> data<font color="#990000">.</font>name<font color="#990000">;</font>
          webSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> ready<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> keys<font color="#990000">:</font> keys<font color="#990000">,</font> motd<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>motd<font color="#990000">,</font> roomLocked<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked <font color="#FF0000">}</font><font color="#990000">));</font>
          <i><font color="#9A1900">// session.room_id = "" + data.room_id;</font></i>
          <i><font color="#9A1900">// Deliver all the messages we queued up since the user connected.</font></i>


          <i><font color="#9A1900">// Note that we've now received the user info message.</font></i>
          receivedUserInfo <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>

          <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>msg<font color="#990000">.</font>data<font color="#990000">,</font> <font color="#FF0000">'L449'</font><font color="#990000">).</font>ready<font color="#990000">)</font> <font color="#FF0000">{</font>
          webSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>session<font color="#990000">.</font>blockedMessages<font color="#990000">)</font>
          <i><font color="#9A1900">// session.blockedMessages.forEach(queued =&gt; {</font></i>
          <i><font color="#9A1900">//   webSocket.send(queued);</font></i>
          <i><font color="#9A1900">// });</font></i>
          <b><font color="#0000FF">delete</font></b> session<font color="#990000">.</font>blockedMessages<font color="#990000">;</font>
          <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ownerUnread <font color="#990000">+=</font> <font color="#993399">1</font><font color="#990000">;</font>
        let ts <font color="#990000">=</font> Math<font color="#990000">.</font><b><font color="#000000">max</font></b><font color="#990000">(</font>Date<font color="#990000">.</font><b><font color="#000000">now</font></b><font color="#990000">(),</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lastTimestamp <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lastTimestamp <font color="#990000">=</font> ts<font color="#990000">;</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'lastTimestamp'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lastTimestamp<font color="#990000">)</font>
        ts <font color="#990000">=</font> ts<font color="#990000">.</font><b><font color="#000000">toString</font></b><font color="#990000">(</font><font color="#993399">2</font><font color="#990000">);</font>
        <b><font color="#0000FF">while</font></b> <font color="#990000">(</font>ts<font color="#990000">.</font>length <font color="#990000">&lt;</font> <font color="#993399">42</font><font color="#990000">)</font> ts <font color="#990000">=</font> <font color="#FF0000">"0"</font> <font color="#990000">+</font> ts<font color="#990000">;</font>
        <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">+</font> ts<font color="#990000">;</font>

        let _x <font color="#990000">=</font> <font color="#FF0000">{}</font>
        _x<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>msg<font color="#990000">.</font>data<font color="#990000">,</font> <font color="#FF0000">'L466'</font><font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">broadcast</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_x<font color="#990000">))</font>
        await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>key<font color="#990000">,</font> msg<font color="#990000">.</font>data<font color="#990000">);</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"NOW CALLING FUNCTION"</font><font color="#990000">)</font>
        await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendNotifications</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font>
        <i><font color="#9A1900">// webSocket.send(JSON.stringify({ error: err.stack }));</font></i>
        await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>MESSAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>key<font color="#990000">,</font> msg<font color="#990000">.</font>data<font color="#990000">);</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        <i><font color="#9A1900">// Report any exceptions directly back to the client</font></i>
        webSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'[handleSession()] '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">));</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>

    <i><font color="#9A1900">// On "close" and "error" events, remove the WebSocket from the sessions list and broadcast</font></i>
    <i><font color="#9A1900">// a quit message.</font></i>
    let closeOrErrorHandler <font color="#990000">=</font> evt <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      session<font color="#990000">.</font>quit <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>sessions <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>sessions<font color="#990000">.</font><b><font color="#000000">filter</font></b><font color="#990000">(</font>member <font color="#990000">=&gt;</font> member <font color="#990000">!==</font> session<font color="#990000">);</font>
    <font color="#FF0000">}</font><font color="#990000">;</font>
    webSocket<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"close"</font><font color="#990000">,</font> closeOrErrorHandler<font color="#990000">);</font>
    webSocket<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"error"</font><font color="#990000">,</font> closeOrErrorHandler<font color="#990000">);</font>
  <font color="#FF0000">}</font>

  <i><font color="#9A1900">// broadcast() broadcasts a message to all clients.</font></i>
  <b><font color="#000000">broadcast</font></b><font color="#990000">(</font>message<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">typeof</font></b> message <font color="#990000">!==</font> <font color="#FF0000">"string"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      message <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>message<font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// Iterate over all the sessions sending them messages.</font></i>
    let quitters <font color="#990000">=</font> <font color="#990000">[];</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>sessions <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>sessions<font color="#990000">.</font><b><font color="#000000">filter</font></b><font color="#990000">(</font>session <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>session<font color="#990000">.</font>name<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
          session<font color="#990000">.</font>webSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>message<font color="#990000">);</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>session<font color="#990000">.</font>name <font color="#990000">===</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner<font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ownerUnread <font color="#990000">-=</font> <font color="#993399">1</font><font color="#990000">;</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <font color="#FF0000">{</font>
          session<font color="#990000">.</font>quit <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
          quitters<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>session<font color="#990000">);</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <i><font color="#9A1900">// This session hasn't sent the initial user info message yet, so we're not sending them</font></i>
        <i><font color="#9A1900">// messages yet (no secret lurking!). Queue the message to be sent later.</font></i>
        session<font color="#990000">.</font>blockedMessages<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>message<font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'ownerUnread'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ownerUnread<font color="#990000">);</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">handleOldMessages</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> currentMessagesLength <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'currentMessagesLength'</font><font color="#990000">);</font>
      let storage <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">(</font><font color="#FF0000">{</font> reverse<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> limit<font color="#990000">:</font> <font color="#993399">100</font> <font color="#990000">+</font> currentMessagesLength<font color="#990000">,</font> prefix<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#FF0000">}</font><font color="#990000">);</font>
      let keys <font color="#990000">=</font> <font color="#990000">[...</font>storage<font color="#990000">.</font><b><font color="#000000">keys</font></b><font color="#990000">()];</font>
      keys <font color="#990000">=</font> keys<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font>currentMessagesLength<font color="#990000">);</font>
      keys<font color="#990000">.</font><b><font color="#000000">reverse</font></b><font color="#990000">();</font>
      let backlog <font color="#990000">=</font> <font color="#FF0000">{}</font>
      keys<font color="#990000">.</font><b><font color="#000000">forEach</font></b><font color="#990000">(</font>key <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
          backlog<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">),</font> <font color="#FF0000">'L531'</font><font color="#990000">);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
          console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">)</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font><font color="#990000">)</font>

      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>backlog<font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error fetching older messages: "</font><font color="#990000">,</font> error<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not fetch older messages"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">getKey</font></b><font color="#990000">(</font>type<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>personalRoom<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>type <font color="#990000">===</font> <font color="#FF0000">'ledgerKey'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>LEDGER_KEY<font color="#990000">;</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>type<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>type <font color="#990000">===</font> <font color="#FF0000">'ownerKey'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      let _keys_id <font color="#990000">=</font> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>KEYS_NAMESPACE<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">(</font><font color="#FF0000">{</font> prefix<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">+</font> <font color="#FF0000">'_ownerKey'</font> <font color="#FF0000">}</font><font color="#990000">)).</font>keys<font color="#990000">.</font><b><font color="#000000">map</font></b><font color="#990000">(</font>key <font color="#990000">=&gt;</font> key<font color="#990000">.</font>name<font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_keys_id<font color="#990000">.</font>length <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      let keys <font color="#990000">=</font> _keys_id<font color="#990000">.</font><b><font color="#000000">map</font></b><font color="#990000">(</font>async key <font color="#990000">=&gt;</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>KEYS_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">));</font>
      <b><font color="#0000FF">return</font></b> await keys<font color="#990000">[</font>keys<font color="#990000">.</font>length <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">];</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>type <font color="#990000">===</font> <font color="#FF0000">'ledgerKey'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>KEYS_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>type<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>KEYS_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">+</font> <font color="#FF0000">'_'</font> <font color="#990000">+</font> type<font color="#990000">);</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">postPubKey</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> json <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> keyType <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'type'</font><font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>keyType <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>keyType<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>json<font color="#990000">));</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">initialize</font></b><font color="#990000">();</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error posting pubKey"</font><font color="#990000">,</font> error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> error<font color="#990000">:</font> <font color="#FF0000">'[postPubKey()] '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">handleRoomCapacityChange</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> newLimit <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'capacity'</font><font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity <font color="#990000">=</font> newLimit<font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'room_capacity'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> capacity<font color="#990000">:</font> newLimit <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Could not change room capacity: "</font><font color="#990000">,</font> error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not change room capacity"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">getRoomCapacity</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> capacity<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not fetch room capacity"</font> <font color="#FF0000">}</font><font color="#990000">))</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">getOwnerUnreadMessages</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> unreadMessages<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ownerUnread <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">getPubKeys</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> keys<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">acceptVisitor</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let data<font color="#990000">;</font>
      data <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> ind <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">.</font><b><font color="#000000">indexOf</font></b><font color="#990000">(</font>data<font color="#990000">.</font>pubKey<font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>ind <font color="#990000">&gt;</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests <font color="#990000">=</font> <font color="#990000">[...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests<font color="#990000">,</font> <font color="#990000">...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">.</font><b><font color="#000000">splice</font></b><font color="#990000">(</font>ind<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">)];</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys<font color="#990000">[</font>data<font color="#990000">.</font>pubKey<font color="#990000">]</font> <font color="#990000">=</font> data<font color="#990000">.</font>lockedKey<font color="#990000">;</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'accepted_requests'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests<font color="#990000">));</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'lockedKeys'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys<font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'join_requests'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">))</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not accept visitor"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Could not accept visitor: "</font><font color="#990000">,</font> e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not accept visitor"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">lockRoom</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">.</font>length<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests<font color="#990000">.</font><b><font color="#000000">indexOf</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">[</font>i<font color="#990000">])</font> <font color="#990000">&lt;</font> <font color="#993399">0</font> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">.</font><b><font color="#000000">indexOf</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">[</font>i<font color="#990000">])</font> <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>visitors<font color="#990000">[</font>i<font color="#990000">]);</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'join_requests'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">));</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'locked'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> locked<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Could not lock room: "</font><font color="#990000">,</font> error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not restrict room"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">getJoinRequests</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> join_requests<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Could not get join requests'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">isRoomLocked</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> locked<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>locked <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Could not get restricted status'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">setMOTD</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let data<font color="#990000">;</font>
      data <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>

      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>motd <font color="#990000">=</font> data<font color="#990000">.</font>motd<font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'motd'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>motd<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> motd<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>motd <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Could not set message of the day: "</font><font color="#990000">,</font> e<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not set message of the day"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">ownerKeyRotation</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let _tries <font color="#990000">=</font> <font color="#993399">3</font><font color="#990000">;</font>
      let _timeout <font color="#990000">=</font> <font color="#993399">10000</font><font color="#990000">;</font>
      let _success <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">checkRotation</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>_success<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">while</font></b> <font color="#990000">(</font>_tries <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          _tries <font color="#990000">-=</font> <font color="#993399">1</font><font color="#990000">;</font>
          _success <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">checkRotation</font></b><font color="#990000">(</font>_timeout<font color="#990000">)</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_success<font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
          <font color="#FF0000">}</font>
          _timeout <font color="#990000">*=</font> <font color="#993399">2</font><font color="#990000">;</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>_success<font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">false</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">const</font></b> _updatedKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'ownerKey'</font><font color="#990000">);</font>
      <i><font color="#9A1900">// this.broadcast(JSON.stringify({ control: true, ownerKeyChanged: true, ownerKey: _updatedKey }));</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">=</font> _updatedKey<font color="#990000">;</font>

      <i><font color="#9A1900">// Now pushing all accepted requests back to join requests</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests <font color="#990000">=</font> <font color="#990000">[...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">,</font> <font color="#990000">...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests<font color="#990000">];</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests <font color="#990000">=</font> <font color="#990000">[];</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys <font color="#990000">=</font> <font color="#990000">[];</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'join_requests'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">))</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'lockedKeys'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys<font color="#990000">))</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'accepted_requests'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>accepted_requests<font color="#990000">));</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Check for owner key rotation failed: "</font><font color="#990000">,</font> error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> error<font color="#990000">:</font> <font color="#FF0000">'[ownerKeyRotation()] '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">checkRotation</font></b><font color="#990000">(</font>_timeout<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">(</font>resolve <font color="#990000">=&gt;</font> <b><font color="#000000">setTimeout</font></b><font color="#990000">(</font>resolve<font color="#990000">,</font> _timeout<font color="#990000">));</font>
      <i><font color="#9A1900">/* return new Promise((resolve) =&gt; {</font></i>
<i><font color="#9A1900">        setTimeout(async () =&gt; {</font></i>
<i><font color="#9A1900">          if (await this.getKey('ownerKey') !== this.room_owner) {</font></i>
<i><font color="#9A1900">            resolve(true);</font></i>
<i><font color="#9A1900">          }</font></i>
<i><font color="#9A1900">          resolve(false);</font></i>
<i><font color="#9A1900">        }, _timeout)</font></i>
<i><font color="#9A1900">      })*/</font></i>
      <b><font color="#0000FF">return</font></b> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getKey</font></b><font color="#990000">(</font><font color="#FF0000">'ownerKey'</font><font color="#990000">)</font> <font color="#990000">!==</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner<font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error while checking for owner key rotation: "</font><font color="#990000">,</font> error<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">handleNewStorage</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> size <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'size'</font><font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> storageLimit <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storageLimit<font color="#990000">;</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>size <font color="#990000">&gt;</font> storageLimit<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Not sufficient storage'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storageLimit <font color="#990000">=</font> storageLimit <font color="#990000">-</font> size<font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">'storageLimit'</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storageLimit<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> token_buffer <font color="#990000">=</font> crypto<font color="#990000">.</font><b><font color="#000000">getRandomValues</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font><font color="#993399">48</font><font color="#990000">)).</font>buffer<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> token_hash_buffer <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">digest</font></b><font color="#990000">(</font><font color="#FF0000">'SHA-256'</font><font color="#990000">,</font> token_buffer<font color="#990000">)</font>
      <b><font color="#0000FF">const</font></b> token_hash <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>token_hash_buffer<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> kv_data <font color="#990000">=</font> <font color="#FF0000">{</font> used<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> size<font color="#990000">:</font> size <font color="#FF0000">}</font><font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> kv_resp <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>LEDGER_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>token_hash<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>kv_data<font color="#990000">));</font>
      <b><font color="#0000FF">const</font></b> encrypted_token_id <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font><font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"RSA-OAEP"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>ledgerKey<font color="#990000">,</font> token_buffer<font color="#990000">));</font>
      <b><font color="#0000FF">const</font></b> hashed_room_id <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">digest</font></b><font color="#990000">(</font><font color="#FF0000">'SHA-256'</font><font color="#990000">,</font> <font color="#990000">(</font><b><font color="#0000FF">new</font></b> TextEncoder<font color="#990000">).</font><b><font color="#000000">encode</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">)));</font>
      <b><font color="#0000FF">const</font></b> token <font color="#990000">=</font> <font color="#FF0000">{</font> token_hash<font color="#990000">:</font> token_hash<font color="#990000">,</font> hashed_room_id<font color="#990000">:</font> hashed_room_id<font color="#990000">,</font> encrypted_token_id<font color="#990000">:</font> encrypted_token_id <font color="#FF0000">}</font><font color="#990000">;</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>token<font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'[handleNewStorage()] '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">handleAdminDataRequest</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> join_requests<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>join_requests<font color="#990000">,</font> capacity<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_capacity <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Could not get admin data'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>

    <i><font color="#9A1900">// Parse cookie code from https://stackoverflow.com/questions/51812422/node-js-how-can-i-get-cookie-value-by-cookie-name-from-request</font></i>

    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let cookies <font color="#990000">=</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
      request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">has</font></b><font color="#990000">(</font><font color="#FF0000">'cookie'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'cookie'</font><font color="#990000">).</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">';'</font><font color="#990000">).</font><b><font color="#000000">forEach</font></b><font color="#990000">(</font><b><font color="#0000FF">function</font></b> <font color="#990000">(</font>cookie<font color="#990000">)</font> <font color="#FF0000">{</font>
        let parts <font color="#990000">=</font> cookie<font color="#990000">.</font><b><font color="#000000">match</font></b><font color="#990000">(</font><font color="#FF6600">/(.*?)=(.*)$/</font><font color="#990000">)</font>
        cookies<font color="#990000">[</font>parts<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">].</font><b><font color="#000000">trim</font></b><font color="#990000">()]</font> <font color="#990000">=</font> <font color="#990000">(</font>parts<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">]</font> <font color="#990000">||</font> <font color="#FF0000">''</font><font color="#990000">).</font><b><font color="#000000">trim</font></b><font color="#990000">();</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>cookies<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'token_'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">))</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">const</font></b> verificationKey <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>KEYS_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id <font color="#990000">+</font> <font color="#FF0000">'_authorizationKey'</font><font color="#990000">),</font> <font color="#FF0000">'L778'</font><font color="#990000">),</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"ECDSA"</font><font color="#990000">,</font> namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">'verify'</font><font color="#990000">]);</font>
      <b><font color="#0000FF">const</font></b> auth_parts <font color="#990000">=</font> cookies<font color="#990000">[</font><font color="#FF0000">'token_'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">].</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'.'</font><font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> payload <font color="#990000">=</font> auth_parts<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">];</font>
      <b><font color="#0000FF">const</font></b> sign <font color="#990000">=</font> auth_parts<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">];</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifySign</font></b><font color="#990000">(</font>verificationKey<font color="#990000">,</font> sign<font color="#990000">,</font> payload <font color="#990000">+</font> <font color="#FF0000">'_'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">((</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">()).</font><b><font color="#000000">getTime</font></b><font color="#990000">()</font> <font color="#990000">-</font> <b><font color="#000000">parseInt</font></b><font color="#990000">(</font>payload<font color="#990000">))</font> <font color="#990000">&lt;</font> <font color="#993399">86400000</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">verifyAuthSign</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">has</font></b><font color="#990000">(</font><font color="#FF0000">'authorization'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      let auth_parts <font color="#990000">=</font> request<font color="#990000">.</font>headers<font color="#990000">[</font><font color="#FF0000">'authorization'</font><font color="#990000">].</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'.'</font><font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">().</font><b><font color="#000000">getTime</font></b><font color="#990000">()</font> <font color="#990000">-</font> <b><font color="#000000">parseInt</font></b><font color="#990000">(</font>auth_parts<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">])</font> <font color="#990000">&gt;</font> <font color="#993399">60000</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      let sign <font color="#990000">=</font> auth_parts<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">];</font>
      let ownerKey <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner<font color="#990000">,</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"deriveKey"</font><font color="#990000">]);</font>
      let roomSignKey <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>signKey<font color="#990000">,</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"deriveKey"</font><font color="#990000">]);</font>
      let verificationKey <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font>
        <font color="#FF0000">{</font>
          name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font>
          <b><font color="#0000FF">public</font></b><font color="#990000">:</font> ownerKey
        <font color="#FF0000">}</font><font color="#990000">,</font>
        roomSignKey<font color="#990000">,</font>
        <font color="#FF0000">{</font>
          name<font color="#990000">:</font> <font color="#FF0000">"HMAC"</font><font color="#990000">,</font>
          hash<font color="#990000">:</font> <font color="#FF0000">"SHA-256"</font><font color="#990000">,</font>
          length<font color="#990000">:</font> <font color="#993399">256</font>
        <font color="#FF0000">}</font><font color="#990000">,</font>
        <b><font color="#0000FF">false</font></b><font color="#990000">,</font>
        <font color="#990000">[</font><font color="#FF0000">"verify"</font><font color="#990000">]);</font>
      <b><font color="#0000FF">return</font></b> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">verify</font></b><font color="#990000">(</font><font color="#FF0000">"HMAC"</font><font color="#990000">,</font> verificationKey<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font>sign<font color="#990000">),</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">().</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>auth_parts<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]));</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error verifying sign"</font><font color="#990000">,</font> error<font color="#990000">.</font>stack<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">verifySign</font></b><font color="#990000">(</font>secretKey<font color="#990000">,</font> sign<font color="#990000">,</font> contents<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> _sign <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font><b><font color="#000000">decodeURIComponent</font></b><font color="#990000">(</font>sign<font color="#990000">));</font>
      <b><font color="#0000FF">const</font></b> encoder <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> encoded <font color="#990000">=</font> encoder<font color="#990000">.</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>contents<font color="#990000">);</font>
      let verified <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">verify</font></b><font color="#990000">(</font>
        <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">'ECDSA'</font><font color="#990000">,</font> hash<font color="#990000">:</font> <font color="#FF0000">'SHA-256'</font> <font color="#FF0000">}</font><font color="#990000">,</font>
        secretKey<font color="#990000">,</font>
        _sign<font color="#990000">,</font>
        encoded
      <font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> verified<font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">sign</font></b><font color="#990000">(</font>secretKey<font color="#990000">,</font> contents<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> encoder <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> encoded <font color="#990000">=</font> encoder<font color="#990000">.</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>contents<font color="#990000">);</font>
      let sign<font color="#990000">;</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        sign <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font>
          <font color="#FF0000">'HMAC'</font><font color="#990000">,</font>
          secretKey<font color="#990000">,</font>
          encoded
        <font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>sign<font color="#990000">));</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        <i><font color="#9A1900">// console.log(error);</font></i>
        <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Failed to sign content"</font> <font color="#FF0000">}</font><font color="#990000">;</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// console.log(error);</font></i>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'[sign() ]'</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font> <font color="#990000">+</font> error<font color="#990000">.</font>stack <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">jwtSign</font></b><font color="#990000">(</font>payload<font color="#990000">,</font> secret<font color="#990000">,</font> options<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Trying to create sign: "</font><font color="#990000">,</font> payload<font color="#990000">,</font> <b><font color="#0000FF">typeof</font></b> payload<font color="#990000">,</font> secret<font color="#990000">,</font> <b><font color="#0000FF">typeof</font></b> secret<font color="#990000">)</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>payload <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">||</font> <b><font color="#0000FF">typeof</font></b> payload <font color="#990000">!==</font> <font color="#FF0000">'object'</font><font color="#990000">)</font>
      <b><font color="#0000FF">throw</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">'payload must be an object'</font><font color="#990000">)</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">typeof</font></b> secret <font color="#990000">!==</font> <font color="#FF0000">'string'</font><font color="#990000">)</font>
      <b><font color="#0000FF">throw</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">'secret must be a string'</font><font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> importAlgorithm <font color="#990000">=</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">'ECDSA'</font><font color="#990000">,</font> namedCurve<font color="#990000">:</font> <font color="#FF0000">'P-256'</font><font color="#990000">,</font> hash<font color="#990000">:</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">'SHA-256'</font> <font color="#FF0000">}</font> <font color="#FF0000">}</font>

    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"PAST THROWS"</font><font color="#990000">)</font>
    payload<font color="#990000">.</font>iat <font color="#990000">=</font> Math<font color="#990000">.</font><b><font color="#000000">floor</font></b><font color="#990000">(</font>Date<font color="#990000">.</font><b><font color="#000000">now</font></b><font color="#990000">()</font> <font color="#990000">/</font> <font color="#993399">1000</font><font color="#990000">)</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>claimIat <font color="#990000">=</font> payload<font color="#990000">.</font>iat<font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">"claimIat"</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>claimIat<font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> payloadAsJSON <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>payload<font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> partialToken <font color="#990000">=</font> `$<font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">jwtStringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">_utf8ToUint8Array</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> alg<font color="#990000">:</font> options<font color="#990000">.</font>algorithm<font color="#990000">,</font> kid<font color="#990000">:</font> options<font color="#990000">.</font>keyid <font color="#FF0000">}</font><font color="#990000">)))</font><font color="#FF0000">}</font><font color="#990000">.</font>$<font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">jwtStringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">_utf8ToUint8Array</font></b><font color="#990000">(</font>payloadAsJSON<font color="#990000">))</font><font color="#FF0000">}</font>`
    let keyFormat <font color="#990000">=</font> <font color="#FF0000">'raw'</font>
    let keyData
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>secret<font color="#990000">.</font><b><font color="#000000">startsWith</font></b><font color="#990000">(</font><font color="#FF0000">'-----BEGIN'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
      keyFormat <font color="#990000">=</font> <font color="#FF0000">'pkcs8'</font>
      keyData <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">jwt_str2ab</font></b><font color="#990000">(</font><b><font color="#000000">atob</font></b><font color="#990000">(</font>secret<font color="#990000">.</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/-----BEGIN.*?-----/g</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/-----END.*?-----/g</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/\s/g</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">)))</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b>
      keyData <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">_utf8ToUint8Array</font></b><font color="#990000">(</font>secret<font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font>keyFormat<font color="#990000">,</font> keyData<font color="#990000">,</font> importAlgorithm<font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">'sign'</font><font color="#990000">])</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"GOT KEY: "</font><font color="#990000">,</font> key<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> signature <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font>importAlgorithm<font color="#990000">,</font> key<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">_utf8ToUint8Array</font></b><font color="#990000">(</font>partialToken<font color="#990000">))</font>
    <b><font color="#0000FF">return</font></b> `$<font color="#FF0000">{</font>partialToken<font color="#FF0000">}</font><font color="#990000">.</font>$<font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">jwtStringify</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>signature<font color="#990000">))</font><font color="#FF0000">}</font>`
  <font color="#FF0000">}</font>

  <b><font color="#000000">_utf8ToUint8Array</font></b><font color="#990000">(</font>str<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">jwtParse</font></b><font color="#990000">(</font><b><font color="#000000">btoa</font></b><font color="#990000">(</font><b><font color="#000000">unescape</font></b><font color="#990000">(</font><b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>str<font color="#990000">))))</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">jwtParse</font></b><font color="#990000">(</font>s<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>Array<font color="#990000">.</font><b><font color="#0000FF">prototype</font></b><font color="#990000">.</font>map<font color="#990000">.</font><b><font color="#000000">call</font></b><font color="#990000">(</font><b><font color="#000000">atob</font></b><font color="#990000">(</font>s<font color="#990000">.</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/-/g</font><font color="#990000">,</font> <font color="#FF0000">'+'</font><font color="#990000">).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/_/g</font><font color="#990000">,</font> <font color="#FF0000">'/'</font><font color="#990000">).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/\s/g</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">)),</font> c <font color="#990000">=&gt;</font> c<font color="#990000">.</font><b><font color="#000000">charCodeAt</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)))</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">jwtStringify</font></b><font color="#990000">(</font>a<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">btoa</font></b><font color="#990000">(</font>String<font color="#990000">.</font>fromCharCode<font color="#990000">.</font><b><font color="#000000">apply</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> a<font color="#990000">)).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/=/g</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/\+/g</font><font color="#990000">,</font> <font color="#FF0000">'-'</font><font color="#990000">).</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF6600">/\//g</font><font color="#990000">,</font> <font color="#FF0000">'_'</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">jwt_str2ab</font></b><font color="#990000">(</font>str<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> buf <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">ArrayBuffer</font></b><font color="#990000">(</font>str<font color="#990000">.</font>length<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> bufView <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>buf<font color="#990000">);</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> strLen <font color="#990000">=</font> str<font color="#990000">.</font>length<font color="#990000">;</font> i <font color="#990000">&lt;</font> strLen<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
      bufView<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">=</font> str<font color="#990000">.</font><b><font color="#000000">charCodeAt</font></b><font color="#990000">(</font>i<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> buf<font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">addNewlines</font></b><font color="#990000">(</font>str<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">var</font></b> result <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">while</font></b> <font color="#990000">(</font>str<font color="#990000">.</font>length <font color="#990000">&gt;</font> <font color="#993399">64</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      result <font color="#990000">+=</font> str<font color="#990000">.</font><b><font color="#000000">substring</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">64</font><font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font>
      str <font color="#990000">=</font> str<font color="#990000">.</font><b><font color="#000000">substring</font></b><font color="#990000">(</font><font color="#993399">64</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    result <font color="#990000">+=</font> str
    <b><font color="#0000FF">return</font></b> result<font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">ab2str</font></b><font color="#990000">(</font>buf<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> String<font color="#990000">.</font>fromCharCode<font color="#990000">.</font><b><font color="#000000">apply</font></b><font color="#990000">(</font><b><font color="#0000FF">null</font></b><font color="#990000">,</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>buf<font color="#990000">));</font>
  <font color="#FF0000">}</font>

  <i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">  Export the given key and write it into the "exported-key" space.</font></i>
<i><font color="#9A1900">  */</font></i>
  async <b><font color="#000000">exportPrivateCryptoKey</font></b><font color="#990000">(</font>key<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> exported <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">exportKey</font></b><font color="#990000">(</font>
      <font color="#FF0000">"pkcs8"</font><font color="#990000">,</font>
      key
    <font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> exportedAsString <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">ab2str</font></b><font color="#990000">(</font>exported<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> exportedAsBase64 <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">addNewlines</font></b><font color="#990000">(</font><b><font color="#000000">btoa</font></b><font color="#990000">(</font>exportedAsString<font color="#990000">))</font>
    <b><font color="#0000FF">const</font></b> pemExported <font color="#990000">=</font> `<font color="#990000">-----</font>BEGIN PRIVATE KEY<font color="#990000">-----\</font>n$<font color="#FF0000">{</font>exportedAsBase64<font color="#FF0000">}</font><font color="#990000">\</font>n<font color="#990000">-----</font>END PRIVATE KEY<font color="#990000">-----</font>`<font color="#990000">;</font>

    <b><font color="#0000FF">return</font></b> pemExported
  <font color="#FF0000">}</font>

  async <b><font color="#000000">exportPublicCryptoKey</font></b><font color="#990000">(</font>key<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> exported <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">exportKey</font></b><font color="#990000">(</font>
      <font color="#FF0000">"spki"</font><font color="#990000">,</font>
      key
    <font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> exportedAsString <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">ab2str</font></b><font color="#990000">(</font>exported<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> exportedAsBase64 <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">addNewlines</font></b><font color="#990000">(</font><b><font color="#000000">btoa</font></b><font color="#990000">(</font>exportedAsString<font color="#990000">));</font>
    <b><font color="#0000FF">const</font></b> pemExported <font color="#990000">=</font> `<font color="#990000">-----</font>BEGIN PUBLIC KEY<font color="#990000">-----\</font>n$<font color="#FF0000">{</font>exportedAsBase64<font color="#FF0000">}</font><font color="#990000">\</font>n<font color="#990000">-----</font>END PUBLIC KEY<font color="#990000">-----</font>`<font color="#990000">;</font>

    <b><font color="#0000FF">return</font></b> pemExported<font color="#990000">;</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">convertToPem</font></b><font color="#990000">(</font>keys<font color="#990000">)</font> <font color="#FF0000">{</font>
    let _keys <font color="#990000">=</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let key <b><font color="#0000FF">in</font></b> keys<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">||</font> keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">===</font> <font color="#FF0000">""</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">continue</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">const</font></b> keyType <font color="#990000">=</font> key<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'_'</font><font color="#990000">).</font><b><font color="#000000">slice</font></b><font color="#990000">(-</font><font color="#993399">1</font><font color="#990000">)[</font><font color="#993399">0</font><font color="#990000">];</font>
        let val <font color="#990000">=</font> <b><font color="#0000FF">typeof</font></b> keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">===</font> <font color="#FF0000">'object'</font> <font color="#990000">?</font> keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">:</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>keys<font color="#990000">[</font>key<font color="#990000">],</font> <font color="#FF0000">'L956'</font><font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>keyType <font color="#990000">===</font> <font color="#FF0000">'encryptionKey'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">const</font></b> cryptoKey <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> val<font color="#990000">,</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font><font color="#990000">,</font> length<font color="#990000">:</font> <font color="#993399">256</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">'encrypt'</font><font color="#990000">,</font> <font color="#FF0000">'decrypt'</font><font color="#990000">]);</font>
          <b><font color="#0000FF">const</font></b> exported <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">exportKey</font></b><font color="#990000">(</font><font color="#FF0000">"raw"</font><font color="#990000">,</font> cryptoKey<font color="#990000">);</font>
          _keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> <b><font color="#000000">btoa</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">ab2str</font></b><font color="#990000">(</font>exported<font color="#990000">));</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>keyType <font color="#990000">===</font> <font color="#FF0000">'signKey'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">const</font></b> cryptoKey <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> val<font color="#990000">,</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">'deriveKey'</font><font color="#990000">]);</font>
          <b><font color="#0000FF">const</font></b> _pemKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">exportPrivateCryptoKey</font></b><font color="#990000">(</font>cryptoKey<font color="#990000">);</font>
          _keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> _pemKey<font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
          <b><font color="#0000FF">const</font></b> cryptoKey <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> val<font color="#990000">,</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]);</font>
          <b><font color="#0000FF">const</font></b> _pemKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">exportPublicCryptoKey</font></b><font color="#990000">(</font>cryptoKey<font color="#990000">);</font>
          _keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> _pemKey<font color="#990000">;</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#FF0000">{</font>
        _keys<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">"ERROR"</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> _keys<font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font>base64<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">var</font></b> binary_string <font color="#990000">=</font> <b><font color="#000000">atob</font></b><font color="#990000">(</font>base64<font color="#990000">);</font>
    <b><font color="#0000FF">var</font></b> len <font color="#990000">=</font> binary_string<font color="#990000">.</font>length<font color="#990000">;</font>
    <b><font color="#0000FF">var</font></b> bytes <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>len<font color="#990000">);</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font><b><font color="#0000FF">var</font></b> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> len<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
      bytes<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">=</font> binary_string<font color="#990000">.</font><b><font color="#000000">charCodeAt</font></b><font color="#990000">(</font>i<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> bytes<font color="#990000">.</font>buffer<font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>buffer<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// try {  // better to just throw the error</font></i>

    let binary <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> bytes <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>buffer<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> len <font color="#990000">=</font> bytes<font color="#990000">.</font>byteLength<font color="#990000">;</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> len<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
      binary <font color="#990000">+=</font> String<font color="#990000">.</font><b><font color="#000000">fromCharCode</font></b><font color="#990000">(</font>bytes<font color="#990000">[</font>i<font color="#990000">]);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">btoa</font></b><font color="#990000">(</font>binary<font color="#990000">);</font>

    <i><font color="#9A1900">// }</font></i>
    <i><font color="#9A1900">// catch (e) {</font></i>
    <i><font color="#9A1900">//   console.log(e);</font></i>
    <i><font color="#9A1900">//   return { error: e };</font></i>
    <i><font color="#9A1900">// }</font></i>
  <font color="#FF0000">}</font>

  <b><font color="#000000">checkJsonExistence</font></b><font color="#990000">(</font>val<font color="#990000">,</font> arr<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> arr<font color="#990000">.</font>length<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areJsonKeysSame</font></b><font color="#990000">(</font>val<font color="#990000">,</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>arr<font color="#990000">[</font>i<font color="#990000">],</font> <font color="#FF0000">'L1008'</font><font color="#990000">)))</font>
          <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">continue</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">getLockedKey</font></b><font color="#990000">(</font>val<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let key of Object<font color="#990000">.</font><b><font color="#000000">keys</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys<font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areJsonKeysSame</font></b><font color="#990000">(</font>val<font color="#990000">,</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>key<font color="#990000">,</font> <font color="#FF0000">'L1019'</font><font color="#990000">)))</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>lockedKeys<font color="#990000">[</font>key<font color="#990000">];</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not find key"</font> <font color="#FF0000">}</font><font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">areJsonKeysSame</font></b><font color="#990000">(</font>key1<font color="#990000">,</font> key2<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>key1<font color="#990000">[</font><font color="#FF0000">"x"</font><font color="#990000">]</font> <font color="#990000">==</font> key2<font color="#990000">[</font><font color="#FF0000">"x"</font><font color="#990000">])</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>key1<font color="#990000">[</font><font color="#FF0000">"y"</font><font color="#990000">]</font> <font color="#990000">==</font> key2<font color="#990000">[</font><font color="#FF0000">"y"</font><font color="#990000">]);</font>
  <font color="#FF0000">}</font>

  <b><font color="#000000">registerDevice</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Registering device"</font><font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds <font color="#990000">=</font> <font color="#990000">[...</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Set</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">)];</font>
    let deviceId <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"id"</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">.</font><b><font color="#000000">includes</font></b><font color="#990000">(</font>deviceId<font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>deviceId<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">"deviceIds"</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">));</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>

  async <b><font color="#000000">sendNotifications</font></b><font color="#990000">(</font>dev <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Trying to send notifications"</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>claimIat<font color="#990000">)</font>
    let jwtToken <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>notificationToken<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">((</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>claimIat <font color="#990000">-</font> <font color="#990000">(</font>Math<font color="#990000">.</font><b><font color="#000000">round</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">().</font><b><font color="#000000">getTime</font></b><font color="#990000">()</font> <font color="#990000">/</font> <font color="#993399">1000</font><font color="#990000">)))</font> <font color="#990000">&gt;</font> <font color="#993399">3000</font> <font color="#990000">||</font> jwtToken <font color="#990000">===</font> <font color="#FF0000">""</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Refreshing token"</font><font color="#990000">)</font>
      <b><font color="#0000FF">const</font></b> claim <font color="#990000">=</font> <font color="#FF0000">{</font> iss<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>ISS <font color="#FF0000">}</font><font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> pemKey <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>APS_KEY<font color="#990000">;</font>
      <i><font color="#9A1900">// console.log("IN IF CLAUSE", claim, pemKey);</font></i>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        jwtToken <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">jwtSign</font></b><font color="#990000">(</font>claim<font color="#990000">,</font> pemKey<font color="#990000">,</font> <font color="#FF0000">{</font> algorithm<font color="#990000">:</font> <font color="#FF0000">"ES256"</font><font color="#990000">,</font> keyid<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>KID <font color="#FF0000">}</font><font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">"notificationToken"</font><font color="#990000">,</font> jwtToken<font color="#990000">)</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error signing with jwt: "</font><font color="#990000">,</font> err<font color="#990000">.</font>message<font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>notificationToken <font color="#990000">=</font> jwtToken<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    let notificationJSON <font color="#990000">=</font> <font color="#FF0000">{</font>
      aps<font color="#990000">:</font> <font color="#FF0000">{</font>
        alert<font color="#990000">:</font> <font color="#FF0000">{</font>
          title<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">,</font>
          subtitle<font color="#990000">:</font> <font color="#FF0000">"You have a new message!"</font>
        <font color="#FF0000">}</font><font color="#990000">,</font>
        sound<font color="#990000">:</font> <font color="#FF0000">"default"</font><font color="#990000">,</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">;</font>
    notificationJSON<font color="#990000">.</font>aps<font color="#990000">[</font><font color="#FF0000">"mutable-content"</font><font color="#990000">]</font> <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    notificationJSON<font color="#990000">.</font>aps<font color="#990000">[</font><font color="#FF0000">"interruption-level"</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">"active"</font><font color="#990000">;</font>
    let notification <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>notificationJSON<font color="#990000">)</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"TOKEN"</font><font color="#990000">,</font> jwtToken<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font> notification<font color="#990000">)</font>
    let base <font color="#990000">=</font> dev <font color="#990000">?</font> <font color="#FF0000">"https://api.sandbox.push.apple.com/3/device/"</font> <font color="#990000">:</font> <font color="#FF0000">"https://api.push.apple.com/3/device/"</font>
    <i><font color="#9A1900">// console.log("DEVICE LENGTH: ", this.deviceIds.length)</font></i>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">.</font>length<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Pinging: "</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">[</font>i<font color="#990000">]);</font>
      <b><font color="#0000FF">const</font></b> device_token <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>deviceIds<font color="#990000">[</font>i<font color="#990000">];</font>
      let url <font color="#990000">=</font> base <font color="#990000">+</font> device_token<font color="#990000">;</font>
      let request <font color="#990000">=</font> <font color="#FF0000">{</font>
        method<font color="#990000">:</font> <font color="#FF0000">"POST"</font><font color="#990000">,</font>
        headers<font color="#990000">:</font> <font color="#FF0000">{</font>
          <font color="#FF0000">"authorization"</font><font color="#990000">:</font> <font color="#FF0000">"bearer "</font> <font color="#990000">+</font> jwtToken<font color="#990000">,</font>
          <font color="#FF0000">"apns-topic"</font><font color="#990000">:</font> <font color="#FF0000">"app.snackabra"</font><font color="#990000">,</font>
          <font color="#FF0000">"apns-push-type"</font><font color="#990000">:</font> <font color="#FF0000">"alert"</font>
        <font color="#FF0000">}</font><font color="#990000">,</font>
        body<font color="#990000">:</font> notification
      <font color="#FF0000">}</font>
      let req <font color="#990000">=</font> await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>url<font color="#990000">,</font> request<font color="#990000">);</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Request is: "</font><font color="#990000">,</font> url<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>request<font color="#990000">))</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">'APPLE RESPONSE'</font><font color="#990000">,</font> req<font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">downloadAllData</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    let storage <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">();</font>
    let data <font color="#990000">=</font> <font color="#FF0000">{</font> roomId<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">,</font> ownerKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner<font color="#990000">,</font> encryptionKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>encryptionKey<font color="#990000">,</font> guestKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>verified_guest<font color="#990000">,</font> signKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>signKey <font color="#FF0000">}</font><font color="#990000">;</font>
    storage<font color="#990000">.</font><b><font color="#000000">forEach</font></b><font color="#990000">((</font>value<font color="#990000">,</font> key<font color="#990000">,</font> map<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      data<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">=</font> value<font color="#990000">;</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verifyCookie</font></b><font color="#990000">(</font>request<font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>room_capacity<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>visitors<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>ownerUnread<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>join_requests<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>accepted_requests<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>storageLimit<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>lockedKeys<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>deviceIds<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>claimIat<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> data<font color="#990000">.</font>notificationToken<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    let dataBlob <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">().</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>data<font color="#990000">));</font>
    <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
      <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type, authorization"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>dataBlob<font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">200</font><font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">uploadData</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    let _secret <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>SERVER_SECRET<font color="#990000">;</font>
    let data <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
    let jsonString <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextDecoder</font></b><font color="#990000">().</font><b><font color="#000000">decode</font></b><font color="#990000">(</font>data<font color="#990000">);</font>
    let jsonData <font color="#990000">=</font> <b><font color="#000000">jsonParseWrapper</font></b><font color="#990000">(</font>jsonString<font color="#990000">,</font> <font color="#FF0000">'L1126'</font><font color="#990000">);</font>
    let roomInitialized <font color="#990000">=</font> <font color="#990000">!(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">===</font> <font color="#FF0000">""</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">===</font> <b><font color="#0000FF">null</font></b><font color="#990000">);</font>
    let requestAuthorized <font color="#990000">=</font> jsonData<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">"SERVER_SECRET"</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> jsonData<font color="#990000">[</font><font color="#FF0000">"SERVER_SECRET"</font><font color="#990000">]</font> <font color="#990000">===</font> _secret<font color="#990000">;</font>
    let allowed <font color="#990000">=</font> <font color="#990000">(</font>roomInitialized <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">===</font> jsonData<font color="#990000">[</font><font color="#FF0000">"roomOwner"</font><font color="#990000">])</font> <font color="#990000">||</font> requestAuthorized
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>allowed<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let key <b><font color="#0000FF">in</font></b> jsonData<font color="#990000">)</font> <font color="#FF0000">{</font>
        await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>key<font color="#990000">,</font> jsonData<font color="#990000">[</font>key<font color="#990000">]);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>personalRoom <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">"personalRoom"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">initialize</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_id<font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> error<font color="#990000">:</font> <font color="#990000">!</font>roomInitialized <font color="#990000">?</font> <font color="#FF0000">"Server secret did not match"</font> <font color="#990000">:</font> <font color="#FF0000">"Room owner needs to upload the room"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">200</font><font color="#990000">));</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">authorizeRoom</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
    let _secret <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>env<font color="#990000">.</font>SERVER_SECRET<font color="#990000">;</font>
    let jsonData <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
    let requestAuthorized <font color="#990000">=</font> jsonData<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">"SERVER_SECRET"</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> jsonData<font color="#990000">[</font><font color="#FF0000">"SERVER_SECRET"</font><font color="#990000">]</font> <font color="#990000">===</font> _secret<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>requestAuthorized<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let key <b><font color="#0000FF">in</font></b> jsonData<font color="#990000">)</font> <font color="#FF0000">{</font>
        await <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">"room_owner"</font><font color="#990000">,</font> jsonData<font color="#990000">[</font><font color="#FF0000">"ownerKey"</font><font color="#990000">]);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>personalRoom <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>storage<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font><font color="#FF0000">"personalRoom"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>room_owner <font color="#990000">=</font> jsonData<font color="#990000">[</font><font color="#FF0000">"room_owner"</font><font color="#990000">];</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> error<font color="#990000">:</font> <font color="#FF0000">"Server secret did not match"</font> <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#993399">200</font><font color="#990000">));</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>
</tt></pre>

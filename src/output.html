<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>./2023.05.12.index.clean.ts</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl slc">/// &lt;reference types=&quot;&#64;cloudflare/workers-types&quot; /&gt;</span>
<span class="hl kwa">const</span> STORAGE_SIZE_UNIT <span class="hl opt">=</span> <span class="hl num">4096</span><span class="hl opt">;</span>
<span class="hl kwa">const</span> STORAGE_SIZE_MIN <span class="hl opt">=</span> <span class="hl num">8</span> <span class="hl opt">*</span> STORAGE_SIZE_UNIT<span class="hl opt">;</span>
<span class="hl kwa">const</span> STORAGE_SIZE_MAX <span class="hl opt">=</span> <span class="hl num">8192</span> <span class="hl opt">*</span> STORAGE_SIZE_UNIT<span class="hl opt">;</span>
<span class="hl kwa">const</span> NEW_CHANNEL_MINIMUM_BUDGET <span class="hl opt">=</span> <span class="hl num">32</span> <span class="hl opt">*</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span><span class="hl opt">;</span> <span class="hl slc">// 8 MB</span>
<span class="hl kwa">const</span> NEW_CHANNEL_BUDGET <span class="hl opt">=</span> <span class="hl num">3</span> <span class="hl opt">*</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span><span class="hl opt">;</span> <span class="hl slc">// 3 GB</span>
<span class="hl kwa">const</span> MAX_BUDGET_TRANSFER <span class="hl opt">=</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span> <span class="hl opt">*</span> <span class="hl num">1024</span><span class="hl opt">;</span> <span class="hl slc">// 1 PB</span>
<span class="hl kwa">const</span> ALLOW_OWNER_KEY_ROTATION <span class="hl opt">=</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
<span class="hl kwa">import type</span> <span class="hl opt">{</span> ChannelKeys<span class="hl opt">,</span> SBChannelId<span class="hl opt">,</span> ChannelAdminData<span class="hl opt">,</span> ChannelKeyStrings <span class="hl opt">}</span> from <span class="hl sng">&#39;./snackabra.d.ts&#39;</span><span class="hl opt">;</span>
<span class="hl kwa">import</span> <span class="hl opt">{</span> arrayBufferToBase64<span class="hl opt">,</span> base64ToArrayBuffer<span class="hl opt">,</span> jsonParseWrapper<span class="hl opt">,</span> SBCrypto<span class="hl opt">,</span> _sb_assert <span class="hl opt">}</span> from <span class="hl sng">&#39;./snackabra.js&#39;</span><span class="hl opt">;</span>
<span class="hl kwa">const</span> sbCrypto <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SBCrypto</span><span class="hl opt">()</span>
<span class="hl kwa">type</span> EnvType <span class="hl opt">= {</span>
  channels<span class="hl opt">:</span> DurableObjectNamespace<span class="hl opt">,</span>
  notifications<span class="hl opt">:</span> Fetcher
  SERVER_SECRET<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">,</span>
  MESSAGES_NAMESPACE<span class="hl opt">:</span> KVNamespace<span class="hl opt">,</span>
  KEYS_NAMESPACE<span class="hl opt">:</span> KVNamespace<span class="hl opt">,</span>
  LEDGER_NAMESPACE<span class="hl opt">:</span> KVNamespace<span class="hl opt">,</span>
  IMAGES_NAMESPACE<span class="hl opt">:</span> KVNamespace<span class="hl opt">,</span>
  RECOVERY_NAMESPACE<span class="hl opt">:</span> KVNamespace<span class="hl opt">,</span>
  LEDGER_KEY<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">,</span>
<span class="hl opt">}</span>
<span class="hl kwa">type</span> ResponseCode <span class="hl opt">=</span> <span class="hl num">101</span> <span class="hl opt">|</span> <span class="hl num">200</span> <span class="hl opt">|</span> <span class="hl num">400</span> <span class="hl opt">|</span> <span class="hl num">401</span> <span class="hl opt">|</span> <span class="hl num">403</span> <span class="hl opt">|</span> <span class="hl num">404</span> <span class="hl opt">|</span> <span class="hl num">405</span> <span class="hl opt">|</span> <span class="hl num">413</span> <span class="hl opt">|</span> <span class="hl num">418</span> <span class="hl opt">|</span> <span class="hl num">429</span> <span class="hl opt">|</span> <span class="hl num">500</span> <span class="hl opt">|</span> <span class="hl num">501</span> <span class="hl opt">|</span> <span class="hl num">507</span><span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">,</span> contents<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">,</span> <span class="hl kwa">status</span><span class="hl opt">:</span> ResponseCode<span class="hl opt">,</span> delay <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
  <span class="hl kwa">const</span> corsHeaders <span class="hl opt">= {</span>
    <span class="hl sng">&quot;Access-Control-Allow-Methods&quot;</span><span class="hl opt">:</span> <span class="hl sng">&quot;POST, OPTIONS, GET&quot;</span><span class="hl opt">,</span>
    <span class="hl sng">&quot;Access-Control-Allow-Headers&quot;</span><span class="hl opt">:</span> <span class="hl sng">&quot;Content-Type, authorization&quot;</span><span class="hl opt">,</span>
    <span class="hl sng">&quot;Access-Control-Allow-Credentials&quot;</span><span class="hl opt">:</span> <span class="hl sng">&quot;true&quot;</span><span class="hl opt">,</span>
    <span class="hl sng">&quot;Access-Control-Allow-Origin&quot;</span><span class="hl opt">:</span> request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&quot;Origin&quot;</span><span class="hl opt">) ??</span> <span class="hl sng">&quot;*&quot;</span><span class="hl opt">,</span>
    <span class="hl sng">&quot;Content-Type&quot;</span><span class="hl opt">:</span> <span class="hl sng">&quot;application/json;&quot;</span><span class="hl opt">,</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>DEBUG2<span class="hl opt">)</span> console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl sng">&#39;++++++++++++HEADERS+++++++++++++</span><span class="hl esc">\n\n</span><span class="hl sng">&#39;</span><span class="hl opt">,</span> corsHeaders<span class="hl opt">)</span>
  <span class="hl kwa">return new</span> Promise<span class="hl opt">&lt;</span>Response<span class="hl opt">&gt;((</span>resolve<span class="hl opt">) =&gt; {</span>
    <span class="hl kwd">setTimeout</span><span class="hl opt">(() =&gt; {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>DEBUG2<span class="hl opt">)</span> console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl sng">&quot;++++ returnResult() contents:&quot;</span><span class="hl opt">,</span> contents<span class="hl opt">,</span> <span class="hl sng">&quot;status:&quot;</span><span class="hl opt">,</span> <span class="hl kwa">status</span><span class="hl opt">)</span>
      <span class="hl kwd">resolve</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">Response</span><span class="hl opt">(</span>contents<span class="hl opt">, {</span> <span class="hl kwa">status</span><span class="hl opt">:</span> <span class="hl kwa">status</span><span class="hl opt">,</span> headers<span class="hl opt">:</span> corsHeaders <span class="hl opt">}));</span>
    <span class="hl opt">},</span> delay<span class="hl opt">);</span>
  <span class="hl opt">});</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>_request<span class="hl opt">:</span> Request<span class="hl opt">,</span> errorString<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">,</span> <span class="hl kwa">status</span><span class="hl opt">:</span> ResponseCode<span class="hl opt">,</span> delay <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>DEBUG<span class="hl opt">)</span> console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl sng">&quot;**** ERROR: (status: &quot;</span> <span class="hl opt">+</span> <span class="hl kwa">status</span> <span class="hl opt">+</span> <span class="hl sng">&quot;)</span><span class="hl esc">\n</span><span class="hl sng">&quot;</span> <span class="hl opt">+</span> errorString<span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>delay <span class="hl opt">&amp;&amp; ((</span><span class="hl kwa">status</span> <span class="hl opt">==</span> <span class="hl num">401</span><span class="hl opt">) || (</span><span class="hl kwa">status</span> <span class="hl opt">==</span> <span class="hl num">403</span><span class="hl opt">)))</span> delay <span class="hl opt">=</span> <span class="hl num">50</span><span class="hl opt">;</span> <span class="hl slc">// delay if auth-related</span>
  <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>_request<span class="hl opt">,</span> <span class="hl sng">`{ &quot;error&quot;: &quot;</span><span class="hl ipl">${errorString}</span><span class="hl sng">&quot; }`</span><span class="hl opt">,</span> <span class="hl kwa">status</span><span class="hl opt">);</span>
<span class="hl opt">}</span>
<span class="hl kwa">async function</span> <span class="hl kwd">handleErrors</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">,</span> func<span class="hl opt">: () =&gt;</span> Promise<span class="hl opt">&lt;</span>Response<span class="hl opt">&gt;) {</span>
  <span class="hl kwa">try</span> <span class="hl opt">{</span>
    <span class="hl kwa">return await</span> <span class="hl kwd">func</span><span class="hl opt">();</span>
  <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>err<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>err <span class="hl kwa">instanceof Error</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&quot;Upgrade&quot;</span><span class="hl opt">) ==</span> <span class="hl sng">&quot;websocket&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">const</span> <span class="hl opt">[</span>_client<span class="hl opt">,</span> server<span class="hl opt">] =</span> <span class="hl kwb">Object</span><span class="hl opt">.</span><span class="hl kwd">values</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">WebSocketPair</span><span class="hl opt">());</span>
        <span class="hl kwa">if</span> <span class="hl opt">((</span>server <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span>accept<span class="hl opt">) {</span>
          <span class="hl opt">(</span>server <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span><span class="hl kwd">accept</span><span class="hl opt">();</span> <span class="hl slc">// CF typing override (TODO: report this)</span>
          server<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> error<span class="hl opt">:</span> <span class="hl sng">&#39;[handleErrors()] &#39;</span> <span class="hl opt">+</span> err<span class="hl opt">.</span>message <span class="hl opt">+</span> <span class="hl sng">&#39;</span><span class="hl esc">\n</span><span class="hl sng">&#39;</span> <span class="hl opt">+</span> err<span class="hl opt">.</span>stack <span class="hl opt">}));</span>
          server<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">(</span><span class="hl num">1011</span><span class="hl opt">,</span> <span class="hl sng">&quot;Uncaught exception during session setup&quot;</span><span class="hl opt">);</span>
          console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl sng">&quot;webSocket close (error)&quot;</span><span class="hl opt">)</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl kwb">null</span><span class="hl opt">,</span> <span class="hl num">101</span><span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> err<span class="hl opt">.</span>stack<span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">)</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Unknown error type (?) in top level&quot;</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">export default</span> <span class="hl opt">{</span>
  <span class="hl kwa">async</span> <span class="hl kwd">fetch</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">,</span> env<span class="hl opt">:</span> EnvType<span class="hl opt">) {</span>
    <span class="hl kwa">return await</span> <span class="hl kwd">handleErrors</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl kwa">async</span> <span class="hl opt">() =&gt; {</span>
      <span class="hl kwa">const</span> url <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
      <span class="hl kwa">const</span> path <span class="hl opt">=</span> url<span class="hl opt">.</span>pathname<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl sng">&#39;/&#39;</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>request<span class="hl opt">.</span>method <span class="hl opt">==</span> <span class="hl sng">&quot;OPTIONS&quot;</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl kwb">null</span><span class="hl opt">,</span> <span class="hl num">200</span><span class="hl opt">);</span>
      <span class="hl kwa">switch</span> <span class="hl opt">(</span>path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]) {</span>
        <span class="hl kwa">case</span> <span class="hl sng">&quot;api&quot;</span><span class="hl opt">:</span> <span class="hl slc">// /api/... is only case currently</span>
          <span class="hl kwa">return</span> <span class="hl kwd">handleApiRequest</span><span class="hl opt">(</span>path<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">),</span> request<span class="hl opt">,</span> env<span class="hl opt">);</span>
        <span class="hl kwa">default</span><span class="hl opt">:</span>
          <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Not found (must give API endpoint)&quot;</span><span class="hl opt">,</span> <span class="hl num">404</span><span class="hl opt">)</span>
      <span class="hl opt">}</span>
    <span class="hl opt">});</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
<span class="hl kwa">async function</span> <span class="hl kwd">callDurableObject</span><span class="hl opt">(</span>name<span class="hl opt">:</span> SBChannelId<span class="hl opt">,</span> path<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">&gt;,</span> request<span class="hl opt">:</span> Request<span class="hl opt">,</span> env<span class="hl opt">:</span> EnvType<span class="hl opt">) {</span>
  <span class="hl kwa">const</span> roomId <span class="hl opt">=</span> env<span class="hl opt">.</span>channels<span class="hl opt">.</span><span class="hl kwd">idFromName</span><span class="hl opt">(</span>name<span class="hl opt">);</span>
  <span class="hl kwa">const</span> roomObject <span class="hl opt">=</span> env<span class="hl opt">.</span>channels<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>roomId<span class="hl opt">);</span>
  <span class="hl kwa">const</span> newUrl <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
  newUrl<span class="hl opt">.</span>pathname <span class="hl opt">=</span> <span class="hl sng">&quot;/&quot;</span> <span class="hl opt">+</span> name <span class="hl opt">+</span> <span class="hl sng">&quot;/&quot;</span> <span class="hl opt">+</span> path<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl sng">&quot;/&quot;</span><span class="hl opt">);</span>
  <span class="hl kwa">const</span> newRequest <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Request</span><span class="hl opt">(</span>newUrl<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(),</span> request<span class="hl opt">);</span>
  <span class="hl kwa">return</span> roomObject<span class="hl opt">.</span><span class="hl kwd">fetch</span><span class="hl opt">(</span>newRequest<span class="hl opt">);</span>
<span class="hl opt">}</span>
<span class="hl kwa">async function</span> <span class="hl kwd">handleApiRequest</span><span class="hl opt">(</span>path<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">&gt;,</span> request<span class="hl opt">:</span> Request<span class="hl opt">,</span> env<span class="hl opt">:</span> EnvType<span class="hl opt">) {</span>
  <span class="hl kwa">try</span> <span class="hl opt">{</span>
    <span class="hl kwa">switch</span> <span class="hl opt">(</span>path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]) {</span>
      <span class="hl kwa">case</span> <span class="hl sng">&quot;room&quot;</span><span class="hl opt">:</span>
      <span class="hl kwa">case</span> <span class="hl sng">&quot;channel&quot;</span><span class="hl opt">:</span>
        <span class="hl kwa">return</span> <span class="hl kwd">callDurableObject</span><span class="hl opt">(</span>path<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">],</span> path<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">),</span> request<span class="hl opt">,</span> env<span class="hl opt">);</span>
      <span class="hl kwa">case</span> <span class="hl sng">&quot;notifications&quot;</span><span class="hl opt">:</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Device (Apple) notifications are disabled (use web notifications)&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
      <span class="hl kwa">case</span> <span class="hl sng">&quot;getLastMessageTimes&quot;</span><span class="hl opt">:</span>
        <span class="hl opt">{</span>
          <span class="hl kwa">const</span> _rooms<span class="hl opt">:</span> <span class="hl kwb">any</span> <span class="hl opt">=</span> <span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">json</span><span class="hl opt">();</span>
          <span class="hl kwa">const</span> lastMessageTimes<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span><span class="hl kwb">any</span><span class="hl opt">&gt; = [];</span>
          <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">let</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> _rooms<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
            lastMessageTimes<span class="hl opt">[</span>_rooms<span class="hl opt">[</span>i<span class="hl opt">]] =</span> <span class="hl kwa">await</span> <span class="hl kwd">lastTimeStamp</span><span class="hl opt">(</span>_rooms<span class="hl opt">[</span>i<span class="hl opt">],</span> env<span class="hl opt">);</span>
          <span class="hl opt">}</span>
          <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>lastMessageTimes<span class="hl opt">),</span> <span class="hl num">200</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl kwa">default</span><span class="hl opt">:</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> error<span class="hl opt">:</span> <span class="hl sng">&quot;Not found (this is an API endpoint, the URI was malformed)&quot;</span> <span class="hl opt">}),</span> <span class="hl num">404</span><span class="hl opt">)</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>error<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`[API Call error] [</span><span class="hl ipl">${request.url}</span><span class="hl sng">]:</span> <span class="hl esc">\n</span><span class="hl sng">`</span> <span class="hl opt">+</span> error<span class="hl opt">.</span>message <span class="hl opt">+</span> <span class="hl sng">&#39;</span><span class="hl esc">\n</span><span class="hl sng">&#39;</span> <span class="hl opt">+</span> error<span class="hl opt">.</span>stack<span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
<span class="hl kwa">async function</span> <span class="hl kwd">lastTimeStamp</span><span class="hl opt">(</span>room_id<span class="hl opt">:</span> SBChannelId<span class="hl opt">,</span> env<span class="hl opt">:</span> EnvType<span class="hl opt">) {</span>
  <span class="hl kwa">let</span> list_response <span class="hl opt">=</span> <span class="hl kwa">await</span> env<span class="hl opt">.</span>MESSAGES_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">list</span><span class="hl opt">({</span> <span class="hl sng">&quot;prefix&quot;</span><span class="hl opt">:</span> room_id <span class="hl opt">});</span>
  <span class="hl kwa">let</span> message_keys<span class="hl opt">:</span> <span class="hl kwb">any</span> <span class="hl opt">=</span> list_response<span class="hl opt">.</span>keys<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">((</span>res<span class="hl opt">) =&gt; {</span>
    <span class="hl kwa">return</span> res<span class="hl opt">.</span>name
  <span class="hl opt">});</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>message_keys<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl sng">&#39;0&#39;</span>
  <span class="hl kwa">while</span> <span class="hl opt">(!</span>list_response<span class="hl opt">.</span>list_complete<span class="hl opt">) {</span>
    list_response <span class="hl opt">=</span> <span class="hl kwa">await</span> env<span class="hl opt">.</span>MESSAGES_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">list</span><span class="hl opt">({</span> <span class="hl sng">&quot;cursor&quot;</span><span class="hl opt">:</span> list_response<span class="hl opt">.</span>cursor <span class="hl opt">})</span>
    message_keys <span class="hl opt">= [...</span>message_keys<span class="hl opt">,</span> list_response<span class="hl opt">.</span>keys<span class="hl opt">];</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">return</span> message_keys<span class="hl opt">[</span>message_keys<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">].</span><span class="hl kwd">slice</span><span class="hl opt">(</span>room_id<span class="hl opt">.</span>length<span class="hl opt">);</span>
<span class="hl opt">}</span>
<span class="hl kwa">interface</span> Dictionary<span class="hl opt">&lt;</span>T<span class="hl opt">&gt; {</span>
  <span class="hl opt">[</span>index<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">]:</span> T<span class="hl opt">;</span>
<span class="hl opt">}</span>
<span class="hl kwa">type</span> ApiCallMap <span class="hl opt">= {</span>
  <span class="hl opt">[</span>key<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">]: ((</span>arg0<span class="hl opt">:</span> Request<span class="hl opt">) =&gt;</span> Promise<span class="hl opt">&lt;</span>Response<span class="hl opt">&gt;) |</span> <span class="hl kwb">undefined</span><span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl kwa">type</span> SessionType <span class="hl opt">= {</span>
  name<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">,</span>
  room_id<span class="hl opt">:</span> SBChannelId<span class="hl opt">,</span>
  webSocket<span class="hl opt">:</span> WebSocket<span class="hl opt">,</span>
  blockedMessages<span class="hl opt">:</span> Map<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">,</span> unknown<span class="hl opt">&gt;,</span>
  quit<span class="hl opt">:</span> <span class="hl kwb">boolean</span><span class="hl opt">,</span>
  receivedUserInfo<span class="hl opt">:</span> <span class="hl kwb">boolean</span>
<span class="hl opt">}</span>

<span class="hl kwa">export class</span> ChannelServer <span class="hl kwa">implements</span> DurableObject <span class="hl opt">{</span>
  storage<span class="hl opt">:</span> DurableObjectStorage<span class="hl opt">;</span>
  env<span class="hl opt">:</span> EnvType<span class="hl opt">;</span>
  initializePromise<span class="hl opt">:</span> Promise<span class="hl opt">&lt;</span><span class="hl kwb">void</span><span class="hl opt">&gt; |</span> <span class="hl kwb">null</span> <span class="hl opt">=</span> <span class="hl kwb">null</span><span class="hl opt">;</span>
  sessions<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span><span class="hl kwb">any</span><span class="hl opt">&gt; = [];</span>
  #channelKeys<span class="hl opt">?:</span> ChannelKeys
  #channelKeyStrings<span class="hl opt">?:</span> ChannelKeyStrings
  room_id<span class="hl opt">:</span> SBChannelId <span class="hl opt">=</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
  room_owner<span class="hl opt">:</span> <span class="hl kwb">string</span> <span class="hl opt">|</span> <span class="hl kwb">null</span> <span class="hl opt">=</span> <span class="hl kwb">null</span><span class="hl opt">;</span> <span class="hl slc">// duplicate, placeholder / TODO cleanup=</span>
  ownerCalls<span class="hl opt">:</span> ApiCallMap<span class="hl opt">;</span>
  visitorCalls<span class="hl opt">:</span> ApiCallMap<span class="hl opt">;</span>
  adminCalls<span class="hl opt">:</span> ApiCallMap<span class="hl opt">;</span>
  lastTimestamp<span class="hl opt">:</span> <span class="hl kwb">number</span> <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> <span class="hl slc">// monotonically increasing timestamp</span>
  storageLimit<span class="hl opt">:</span> <span class="hl kwb">number</span> <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  verified_guest<span class="hl opt">:</span> <span class="hl kwb">string</span> <span class="hl opt">=</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
  visitors<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span>JsonWebKey<span class="hl opt">&gt; = [];</span>
  join_requests<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span>JsonWebKey<span class="hl opt">&gt; = [];</span>
  accepted_requests<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span>JsonWebKey<span class="hl opt">&gt; = [];</span>
  lockedKeys<span class="hl opt">:</span> <span class="hl kwb">Array</span><span class="hl opt">&lt;</span>JsonWebKey<span class="hl opt">&gt; = [];</span> <span class="hl slc">// tracks history of lock keys</span>
  room_capacity<span class="hl opt">:</span> <span class="hl kwb">number</span> <span class="hl opt">=</span> <span class="hl num">20</span><span class="hl opt">;</span>
  ownerUnread<span class="hl opt">:</span> <span class="hl kwb">number</span> <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  locked<span class="hl opt">:</span> <span class="hl kwb">boolean</span> <span class="hl opt">=</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
  motd<span class="hl opt">:</span> <span class="hl kwb">string</span> <span class="hl opt">=</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
  ledgerKey<span class="hl opt">:</span> CryptoKey <span class="hl opt">|</span> <span class="hl kwb">null</span> <span class="hl opt">=</span> <span class="hl kwb">null</span><span class="hl opt">;</span>
  personalRoom<span class="hl opt">:</span> <span class="hl kwb">boolean</span> <span class="hl opt">=</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
  motherChannel<span class="hl opt">:</span> <span class="hl kwb">string</span> <span class="hl opt">=</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
  messagesCursor<span class="hl opt">:</span> <span class="hl kwb">string</span> <span class="hl opt">|</span> <span class="hl kwb">null</span> <span class="hl opt">=</span> <span class="hl kwb">null</span><span class="hl opt">;</span> <span class="hl slc">// used for &#39;startAfter&#39; option</span>
  <span class="hl kwd">constructor</span><span class="hl opt">(</span>state<span class="hl opt">:</span> DurableObjectState<span class="hl opt">,</span> env<span class="hl opt">:</span> EnvType<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage <span class="hl opt">=</span> state<span class="hl opt">.</span>storage<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>env <span class="hl opt">=</span> env<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>ownerCalls <span class="hl opt">= {</span>
      <span class="hl sng">&quot;/acceptVisitor&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#acceptVisitor<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/budd&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#handleBuddRequest<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getAdminData&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#handleAdminDataRequest<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getJoinRequests&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getJoinRequests<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getMother&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getMother<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getPubKeys&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getPubKeys<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getRoomCapacity&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getRoomCapacity<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getStorageLimit&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getStorageLimit<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/lockRoom&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#lockRoom<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/motd&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#setMOTD<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/ownerKeyRotation&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#ownerKeyRotation<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span> <span class="hl slc">// deprecated</span>
      <span class="hl sng">&quot;/ownerUnread&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getOwnerUnreadMessages<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/updateRoomCapacity&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#handleRoomCapacityChange<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>visitorCalls <span class="hl opt">= {</span>
      <span class="hl sng">&quot;/downloadData&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#downloadAllData<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/getChannelKeys&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#getChannelKeys<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/oldMessages&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#handleOldMessages<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/postPubKey&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#postPubKey<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span> <span class="hl slc">// deprecated</span>
      <span class="hl sng">&quot;/registerDevice&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#registerDevice<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span> <span class="hl slc">// deprecated</span>
      <span class="hl sng">&quot;/roomlocked&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#isRoomLocked<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/storageRequest&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#handleNewStorage<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>adminCalls <span class="hl opt">= {</span>
      <span class="hl sng">&quot;/authorizeRoom&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#authorizeRoom<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">),</span>
      <span class="hl sng">&quot;/uploadRoom&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#uploadData<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">)</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">initialize</span><span class="hl opt">(</span>room_id<span class="hl opt">:</span> SBChannelId<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">=</span> room_id<span class="hl opt">;</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;room_id&#39;</span><span class="hl opt">,</span> room_id<span class="hl opt">);</span> <span class="hl slc">// in case we&#39;re new</span>
    <span class="hl kwa">const</span> ledgerKeyString <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>LEDGER_KEY<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>ledgerKeyString<span class="hl opt">)</span>
      <span class="hl kwa">throw new Error</span><span class="hl opt">(</span><span class="hl sng">&quot;ERROR: no ledger key found in environment (fatal)&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> ledgerKey <span class="hl opt">=</span> <span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">importKey</span><span class="hl opt">(</span><span class="hl sng">&quot;jwk&quot;</span><span class="hl opt">,</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>ledgerKeyString<span class="hl opt">,</span> <span class="hl sng">&#39;L217&#39;</span><span class="hl opt">), {</span> name<span class="hl opt">:</span> <span class="hl sng">&quot;RSA-OAEP&quot;</span><span class="hl opt">,</span> hash<span class="hl opt">:</span> <span class="hl sng">&#39;SHA-256&#39;</span> <span class="hl opt">},</span> <span class="hl kwb">true</span><span class="hl opt">, [</span><span class="hl sng">&quot;encrypt&quot;</span><span class="hl opt">])</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>ledgerKey <span class="hl opt">=</span> ledgerKey<span class="hl opt">;</span> <span class="hl slc">// a bit quicker</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>personalRoom <span class="hl opt">= (</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;personalRoom&#39;</span><span class="hl opt">)) ==</span> <span class="hl sng">&#39;false&#39;</span> <span class="hl opt">?</span> <span class="hl kwb">false</span> <span class="hl opt">:</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
    <span class="hl kwa">const</span> keyStrings<span class="hl opt">:</span> ChannelKeyStrings <span class="hl opt">= {</span>
      ownerKey<span class="hl opt">:</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;ownerKey&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">,</span>
      encryptionKey<span class="hl opt">:</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;encryptionKey&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">,</span>
      signKey<span class="hl opt">:</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;signKey&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">const</span> ownerKeyJWK<span class="hl opt">:</span> JsonWebKey <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>keyStrings<span class="hl opt">.</span>ownerKey<span class="hl opt">,</span> <span class="hl sng">&#39;L426&#39;</span><span class="hl opt">)</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">await</span> sbCrypto<span class="hl opt">.</span><span class="hl kwd">verifyChannelId</span><span class="hl opt">(</span>ownerKeyJWK<span class="hl opt">,</span> room_id<span class="hl opt">))) {</span>
      <span class="hl kwa">throw new Error</span><span class="hl opt">(</span><span class="hl sng">&quot;ERROR: owner key does not match room ID (fatal)&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings <span class="hl opt">=</span> keyStrings<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys <span class="hl opt">=</span> <span class="hl kwa">await</span> sbCrypto<span class="hl opt">.</span><span class="hl kwd">channelKeyStringsToCryptoKeys</span><span class="hl opt">(</span>keyStrings<span class="hl opt">)</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>lastTimestamp <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;lastTimestamp&#39;</span><span class="hl opt">)) ||</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>room_owner <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;ownerKey&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>verified_guest <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;guestKey&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
    <span class="hl kwa">const</span> roomCapacity <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;room_capacity&#39;</span><span class="hl opt">)</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity <span class="hl opt">=</span> roomCapacity <span class="hl opt">===</span> <span class="hl sng">&#39;0&#39;</span> <span class="hl opt">?</span> <span class="hl num">0</span> <span class="hl opt">:</span> <span class="hl kwb">Number</span><span class="hl opt">(</span>roomCapacity<span class="hl opt">) ||</span> <span class="hl num">20</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>visitors <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;visitors&#39;</span><span class="hl opt">) ||</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">([]),</span> <span class="hl sng">&#39;L220&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>ownerUnread <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;ownerUnread&#39;</span><span class="hl opt">)) ||</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>locked <span class="hl opt">= (</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;locked&#39;</span><span class="hl opt">)) ===</span> <span class="hl sng">&#39;true&#39;</span> <span class="hl opt">?</span> <span class="hl kwb">true</span> <span class="hl opt">:</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;join_requests&#39;</span><span class="hl opt">) ||</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">([]),</span> <span class="hl sng">&#39;L223&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> storageLimit <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;storageLimit&#39;</span><span class="hl opt">))</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>storageLimit <span class="hl opt">===</span> <span class="hl kwb">Infinity</span><span class="hl opt">) {</span>
      <span class="hl kwa">const</span> ledgerData <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>LEDGER_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>room_id<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>ledgerData<span class="hl opt">) {</span>
        <span class="hl kwa">const</span> <span class="hl opt">{</span> size<span class="hl opt">,</span> mother <span class="hl opt">} =</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>ledgerData<span class="hl opt">,</span> <span class="hl sng">&#39;L311&#39;</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">=</span> <span class="hl num">0</span> <span class="hl slc">// this will actually be topped up in &#39;upload&#39;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>motherChannel <span class="hl opt">=</span> mother
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">=</span> NEW_CHANNEL_BUDGET<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>motherChannel <span class="hl opt">=</span> <span class="hl sng">&#39;BOOTSTRAP&#39;</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;motherChannel&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motherChannel<span class="hl opt">);</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;storageLimit&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">=</span> storageLimit<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>motherChannel <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;motherChannel&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;grandfathered&#39;</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;accepted_requests&#39;</span><span class="hl opt">) ||</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">([]),</span> <span class="hl sng">&#39;L224&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;lockedKeys&#39;</span><span class="hl opt">),</span> <span class="hl sng">&#39;L467&#39;</span><span class="hl opt">) || [];</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>motd <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;motd&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> <span class="hl kwd">fetch</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> url <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> path <span class="hl opt">=</span> url<span class="hl opt">.</span>pathname<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl sng">&#39;/&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">) {</span>
      <span class="hl kwa">const</span> roomId <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;room_id&#39;</span><span class="hl opt">)</span>
        <span class="hl opt">.</span><span class="hl kwa">catch</span><span class="hl opt">((</span>error<span class="hl opt">) =&gt;</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`ERROR: unable to fetch room_id</span> <span class="hl ipl">${error}</span><span class="hl sng">`</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">));</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>roomId<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>roomId <span class="hl opt">!==</span> path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">])</span>
	  <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;ERROR: room_id mismatch (?)&quot;</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">=</span> roomId<span class="hl opt">;</span>
        <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">initialize</span><span class="hl opt">(</span>roomId<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">((</span>path<span class="hl opt">) &amp;&amp; (</span>path<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] ===</span> <span class="hl sng">&#39;uploadRoom&#39;</span><span class="hl opt">)) {</span>
        <span class="hl kwa">const</span> ret <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">createChannel</span><span class="hl opt">(</span>request<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">());</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>ret<span class="hl opt">)</span> <span class="hl kwa">return</span> ret<span class="hl opt">;</span> <span class="hl slc">// if there was an error, return it, otherwise fall through</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Not found (no channel) - only permitted first-touch is an authorized uploadRoom&quot;</span><span class="hl opt">,</span> <span class="hl num">404</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>verified_guest <span class="hl opt">===</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">)</span> <span class="hl slc">// TODO: this needed?</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>verified_guest <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl sng">&#39;guestKey&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">!==</span> path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">])</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;ERROR: room_id mismatch (?) [L522]&quot;</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
    <span class="hl kwa">return await</span> <span class="hl kwd">handleErrors</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl kwa">async</span> <span class="hl opt">() =&gt; {</span>
      <span class="hl kwa">const</span> apiCall <span class="hl opt">=</span> <span class="hl sng">&#39;/&#39;</span> <span class="hl opt">+</span> path<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
      <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>apiCall <span class="hl opt">===</span> <span class="hl sng">&quot;/websocket&quot;</span><span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&quot;Upgrade&quot;</span><span class="hl opt">) !=</span> <span class="hl sng">&quot;websocket&quot;</span><span class="hl opt">)</span>
            <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Expected websocket&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
          <span class="hl kwa">const</span> ip <span class="hl opt">=</span> request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&quot;CF-Connecting-IP&quot;</span><span class="hl opt">);</span>
          <span class="hl kwa">const</span> pair <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">WebSocketPair</span><span class="hl opt">();</span>
          <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">handleSession</span><span class="hl opt">(</span>pair<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">],</span> ip<span class="hl opt">);</span>
          <span class="hl kwa">return new</span> <span class="hl kwd">Response</span><span class="hl opt">(</span><span class="hl kwb">null</span><span class="hl opt">, {</span> <span class="hl kwa">status</span><span class="hl opt">:</span> <span class="hl num">101</span><span class="hl opt">,</span> webSocket<span class="hl opt">:</span> pair<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] });</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>ownerCalls<span class="hl opt">[</span>apiCall<span class="hl opt">]) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">verifyAuth</span><span class="hl opt">(</span>request<span class="hl opt">))</span>
            <span class="hl kwa">return await this</span><span class="hl opt">.</span>ownerCalls<span class="hl opt">[</span>apiCall<span class="hl opt">]!(</span>request<span class="hl opt">);</span>
          <span class="hl kwa">else</span>
	    <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Owner verification failed (restricted API call)&quot;</span><span class="hl opt">,</span> <span class="hl num">401</span><span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>visitorCalls<span class="hl opt">[</span>apiCall<span class="hl opt">]) {</span>
          <span class="hl kwa">return await this</span><span class="hl opt">.</span>visitorCalls<span class="hl opt">[</span>apiCall<span class="hl opt">]!(</span>request<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>adminCalls<span class="hl opt">[</span>apiCall<span class="hl opt">]) {</span>
          <span class="hl kwa">return await this</span><span class="hl opt">.</span>adminCalls<span class="hl opt">[</span>apiCall<span class="hl opt">]!(</span>request<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;API endpoint not found: &quot;</span> <span class="hl opt">+</span> apiCall<span class="hl opt">,</span> <span class="hl num">404</span><span class="hl opt">)</span>
      <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>error<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`API ERROR [</span><span class="hl ipl">${apiCall}</span><span class="hl sng">]:</span> <span class="hl ipl">${error.message}</span> <span class="hl sng"></span><span class="hl esc">\n</span> <span class="hl sng"></span><span class="hl ipl">${error.stack}</span><span class="hl sng">`</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
    <span class="hl opt">});</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getRecentMessages</span><span class="hl opt">(</span>howMany<span class="hl opt">:</span> <span class="hl kwb">number</span><span class="hl opt">,</span> cursor <span class="hl opt">=</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span>Map<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">,</span> unknown<span class="hl opt">&gt;&gt; {</span>
    <span class="hl kwa">const</span> listOptions<span class="hl opt">:</span> DurableObjectListOptions <span class="hl opt">= {</span> limit<span class="hl opt">:</span> howMany<span class="hl opt">,</span> prefix<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">,</span> reverse<span class="hl opt">:</span> <span class="hl kwb">true</span> <span class="hl opt">};</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>cursor <span class="hl opt">!==</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">)</span>
      listOptions<span class="hl opt">.</span>startAfter <span class="hl opt">=</span> cursor<span class="hl opt">;</span>
    <span class="hl kwa">const</span> keys <span class="hl opt">=</span> <span class="hl kwb">Array</span><span class="hl opt">.</span><span class="hl kwd">from</span><span class="hl opt">((</span><span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">list</span><span class="hl opt">(</span>listOptions<span class="hl opt">)).</span><span class="hl kwd">keys</span><span class="hl opt">());</span>
    <span class="hl kwa">const</span> getOptions<span class="hl opt">:</span> DurableObjectGetOptions <span class="hl opt">= {</span> allowConcurrency<span class="hl opt">:</span> <span class="hl kwb">true</span> <span class="hl opt">};</span>
    <span class="hl kwa">const</span> messageList <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>keys<span class="hl opt">,</span> getOptions<span class="hl opt">);</span>
    <span class="hl kwa">return</span> messageList<span class="hl opt">;</span>
  <span class="hl opt">}</span>
  #<span class="hl kwd">setupSession</span><span class="hl opt">(</span>session<span class="hl opt">:</span> SessionType<span class="hl opt">,</span> msg<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">) {</span>
    <span class="hl kwa">const</span> webSocket <span class="hl opt">=</span> session<span class="hl opt">.</span>webSocket<span class="hl opt">;</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">) {</span>
        webSocket<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">(</span><span class="hl num">4000</span><span class="hl opt">,</span> <span class="hl sng">&quot;This room does not have an owner, or the owner has not enabled it. You cannot interact with it yet.&quot;</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">const</span> data <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>msg<span class="hl opt">.</span>data<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(),</span> <span class="hl sng">&#39;L733&#39;</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>data<span class="hl opt">.</span>pem<span class="hl opt">) {</span>
        webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> error<span class="hl opt">:</span> <span class="hl sng">&quot;ERROR: PEM formats no longer used&quot;</span> <span class="hl opt">}));</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>data<span class="hl opt">.</span>name<span class="hl opt">) {</span>
        webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> error<span class="hl opt">:</span> <span class="hl sng">&quot;ERROR: First message needs to contain pubKey&quot;</span> <span class="hl opt">}));</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">const</span> _name<span class="hl opt">:</span> JsonWebKey <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>data<span class="hl opt">.</span>name<span class="hl opt">,</span> <span class="hl sng">&#39;L578&#39;</span><span class="hl opt">);</span>
      <span class="hl kwa">const</span> isPreviousVisitor <span class="hl opt">=</span> sbCrypto<span class="hl opt">.</span><span class="hl kwd">lookupKey</span><span class="hl opt">(</span>_name<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">const</span> isAccepted <span class="hl opt">=</span> sbCrypto<span class="hl opt">.</span><span class="hl kwd">lookupKey</span><span class="hl opt">(</span>_name<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>isPreviousVisitor <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">.</span>length <span class="hl opt">&gt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity<span class="hl opt">) {</span>
        webSocket<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">(</span><span class="hl num">4000</span><span class="hl opt">,</span> <span class="hl sng">&#39;ERROR: The room is not accepting any more visitors.&#39;</span><span class="hl opt">);</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>isPreviousVisitor<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>data<span class="hl opt">.</span>name<span class="hl opt">,</span> <span class="hl sng">&#39;L594&#39;</span><span class="hl opt">));</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;visitors&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">))</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>locked<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>isAccepted <span class="hl opt">&amp;&amp; !</span>isPreviousVisitor<span class="hl opt">) {</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>data<span class="hl opt">.</span>name<span class="hl opt">);</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;join_requests&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">));</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          <span class="hl kwa">const</span> encrypted_key <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys<span class="hl opt">[</span>sbCrypto<span class="hl opt">.</span><span class="hl kwd">lookupKey</span><span class="hl opt">(</span>_name<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys<span class="hl opt">)];</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">!.</span>lockedKey <span class="hl opt">=</span> encrypted_key<span class="hl opt">;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      session<span class="hl opt">.</span>name <span class="hl opt">=</span> data<span class="hl opt">.</span>name<span class="hl opt">;</span>
      webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span>
        ready<span class="hl opt">:</span> <span class="hl kwb">true</span><span class="hl opt">,</span>
        keys<span class="hl opt">: {</span>
          encryptionKey<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">!.</span>encryptionKey<span class="hl opt">,</span>
          ownerKey<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">!.</span>ownerKey<span class="hl opt">,</span>
          signKey<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">!.</span>signKey<span class="hl opt">,</span>
        <span class="hl opt">},</span>
        motd<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motd<span class="hl opt">,</span> roomLocked<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>locked
      <span class="hl opt">}));</span>
      session<span class="hl opt">.</span>room_id <span class="hl opt">=</span> <span class="hl sng">&quot;&quot;</span> <span class="hl opt">+</span> data<span class="hl opt">.</span>room_id<span class="hl opt">;</span>
      session<span class="hl opt">.</span>receivedUserInfo <span class="hl opt">=</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>err<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">) {</span>
      webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> error<span class="hl opt">:</span> <span class="hl sng">&quot;ERROR: problem setting up session: &quot;</span> <span class="hl opt">+</span> err<span class="hl opt">.</span>message <span class="hl opt">+</span> <span class="hl sng">&#39;</span><span class="hl esc">\n</span><span class="hl sng">&#39;</span> <span class="hl opt">+</span> err<span class="hl opt">.</span>stack <span class="hl opt">}));</span>
      <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">handleSession</span><span class="hl opt">(</span>webSocket<span class="hl opt">:</span> WebSocket<span class="hl opt">,</span> _ip<span class="hl opt">:</span> <span class="hl kwb">string</span> <span class="hl opt">|</span> <span class="hl kwb">null</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span>webSocket <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span>accept<span class="hl opt">)</span>
      <span class="hl kwa">throw new Error</span><span class="hl opt">(</span><span class="hl sng">&quot;ERROR: webSocket does not have accept() method&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">(</span>webSocket <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span><span class="hl kwd">accept</span><span class="hl opt">();</span> <span class="hl slc">// typing override</span>
    <span class="hl kwa">const</span> session<span class="hl opt">:</span> SessionType <span class="hl opt">= {</span>
      name<span class="hl opt">:</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">,</span>
      room_id<span class="hl opt">:</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">,</span>
      webSocket<span class="hl opt">:</span> webSocket<span class="hl opt">,</span>
      blockedMessages<span class="hl opt">:</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">getRecentMessages</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">),</span>
      quit<span class="hl opt">:</span> <span class="hl kwb">false</span><span class="hl opt">,</span> <span class="hl slc">// tracks cleanup, true means go away</span>
      receivedUserInfo<span class="hl opt">:</span> <span class="hl kwb">false</span><span class="hl opt">,</span>
    <span class="hl opt">};</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>sessions<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>session<span class="hl opt">);</span>
    webSocket<span class="hl opt">.</span><span class="hl kwd">addEventListener</span><span class="hl opt">(</span><span class="hl sng">&quot;message&quot;</span><span class="hl opt">,</span> msg <span class="hl opt">=&gt; {</span>
      <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>session<span class="hl opt">.</span>quit<span class="hl opt">) {</span>
          webSocket<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">(</span><span class="hl num">1011</span><span class="hl opt">,</span> <span class="hl sng">&quot;WebSocket broken (got a quit).&quot;</span><span class="hl opt">);</span>
          <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>session<span class="hl opt">.</span>receivedUserInfo<span class="hl opt">) {</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span>#<span class="hl kwd">setupSession</span><span class="hl opt">(</span>session<span class="hl opt">,</span> msg<span class="hl opt">);</span>
          <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>msg<span class="hl opt">.</span>data<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(),</span> <span class="hl sng">&#39;L788&#39;</span><span class="hl opt">).</span>ready<span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(!</span>session<span class="hl opt">.</span>blockedMessages<span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
          webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>session<span class="hl opt">.</span>blockedMessages<span class="hl opt">))</span>
          session<span class="hl opt">.</span>blockedMessages<span class="hl opt">.</span><span class="hl kwd">clear</span><span class="hl opt">()</span>
          <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>ownerUnread <span class="hl opt">+=</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl kwa">const</span> tsNum <span class="hl opt">=</span> <span class="hl kwb">Math</span><span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl kwb">Date</span><span class="hl opt">.</span><span class="hl kwd">now</span><span class="hl opt">(),</span> <span class="hl kwa">this</span><span class="hl opt">.</span>lastTimestamp <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>lastTimestamp <span class="hl opt">=</span> tsNum<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;lastTimestamp&#39;</span><span class="hl opt">,</span> tsNum<span class="hl opt">)</span>
        <span class="hl kwa">const</span> ts <span class="hl opt">=</span> tsNum<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">padStart</span><span class="hl opt">(</span><span class="hl num">42</span><span class="hl opt">,</span> <span class="hl sng">&quot;0&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">const</span> key <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">+</span> ts<span class="hl opt">;</span>
        <span class="hl kwa">const</span> _x<span class="hl opt">:</span> Dictionary<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">&gt; = {}</span>
        _x<span class="hl opt">[</span>key<span class="hl opt">] =</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>msg<span class="hl opt">.</span>data<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(),</span> <span class="hl sng">&#39;L812&#39;</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>#<span class="hl kwd">broadcast</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>_x<span class="hl opt">))</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>key<span class="hl opt">,</span> msg<span class="hl opt">.</span>data<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>MESSAGES_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>key<span class="hl opt">,</span> msg<span class="hl opt">.</span>data<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>error<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">) {</span>
        <span class="hl kwa">const</span> err_msg <span class="hl opt">=</span> <span class="hl sng">&#39;[handleSession()] &#39;</span> <span class="hl opt">+</span> error<span class="hl opt">.</span>message <span class="hl opt">+</span> <span class="hl sng">&#39;</span><span class="hl esc">\n</span><span class="hl sng">&#39;</span> <span class="hl opt">+</span> error<span class="hl opt">.</span>stack <span class="hl opt">+</span> <span class="hl sng">&#39;</span><span class="hl esc">\n</span><span class="hl sng">&#39;</span><span class="hl opt">;</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
          webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> error<span class="hl opt">:</span> err_msg <span class="hl opt">}));</span>
        <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">{</span>
          console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl sng">`ERROR: was unable to propagate error to client:</span> <span class="hl ipl">${err_msg}</span><span class="hl sng">`</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
    <span class="hl opt">});</span>
    <span class="hl kwa">const</span> closeOrErrorHandler <span class="hl opt">= () =&gt; {</span>
      session<span class="hl opt">.</span>quit <span class="hl opt">=</span> <span class="hl kwb">true</span><span class="hl opt">;</span> <span class="hl slc">// tells any closure to go away</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>sessions <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>sessions<span class="hl opt">.</span><span class="hl kwd">filter</span><span class="hl opt">(</span>member <span class="hl opt">=&gt;</span> member <span class="hl opt">!==</span> session<span class="hl opt">);</span>
    <span class="hl opt">};</span>
    webSocket<span class="hl opt">.</span><span class="hl kwd">addEventListener</span><span class="hl opt">(</span><span class="hl sng">&quot;close&quot;</span><span class="hl opt">,</span> closeOrErrorHandler<span class="hl opt">);</span>
    webSocket<span class="hl opt">.</span><span class="hl kwd">addEventListener</span><span class="hl opt">(</span><span class="hl sng">&quot;error&quot;</span><span class="hl opt">,</span> closeOrErrorHandler<span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">broadcast</span><span class="hl opt">(</span>message<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> message <span class="hl opt">!==</span> <span class="hl sng">&quot;string&quot;</span><span class="hl opt">)</span>
      message <span class="hl opt">=</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">sendWebNotifications</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>sessions <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>sessions<span class="hl opt">.</span><span class="hl kwd">filter</span><span class="hl opt">(</span>session <span class="hl opt">=&gt; {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>session<span class="hl opt">.</span>name<span class="hl opt">) {</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
          session<span class="hl opt">.</span>webSocket<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>session<span class="hl opt">.</span>name <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">?.</span>ownerPubKeyX<span class="hl opt">)</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>ownerUnread <span class="hl opt">-=</span> <span class="hl num">1</span><span class="hl opt">;</span>
          <span class="hl kwa">return</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>err<span class="hl opt">) {</span>
          session<span class="hl opt">.</span>quit <span class="hl opt">=</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
          <span class="hl kwa">return</span> <span class="hl kwb">false</span><span class="hl opt">;</span> <span class="hl slc">// delete session</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        session<span class="hl opt">.</span>blockedMessages<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
        <span class="hl kwa">return</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">});</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;ownerUnread&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>ownerUnread<span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">handleOldMessages</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> <span class="hl opt">{</span> searchParams <span class="hl opt">} =</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> currentMessagesLength <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span>searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;currentMessagesLength&#39;</span><span class="hl opt">)) ||</span> <span class="hl num">100</span><span class="hl opt">;</span>
    <span class="hl kwa">const</span> cursor <span class="hl opt">=</span> searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;cursor&#39;</span><span class="hl opt">) ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">;</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>#<span class="hl kwd">getRecentMessages</span><span class="hl opt">(</span>currentMessagesLength<span class="hl opt">,</span> cursor<span class="hl opt">)),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getKey</span><span class="hl opt">(</span><span class="hl kwa">type</span><span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span><span class="hl kwb">string</span> <span class="hl opt">|</span> <span class="hl kwb">null</span><span class="hl opt">&gt; {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>personalRoom<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">type</span> <span class="hl opt">===</span> <span class="hl sng">&#39;ledgerKey&#39;</span><span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>LEDGER_KEY<span class="hl opt">;</span>
      <span class="hl kwa">return await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl kwa">type</span><span class="hl opt">) ||</span> <span class="hl kwb">null</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">type</span> <span class="hl opt">===</span> <span class="hl sng">&#39;ownerKey&#39;</span><span class="hl opt">) {</span>
      <span class="hl kwa">const</span> _keys_id <span class="hl opt">= (</span><span class="hl kwa">await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>KEYS_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">list</span><span class="hl opt">({</span> prefix<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">+</span> <span class="hl sng">&#39;_ownerKey&#39;</span> <span class="hl opt">})).</span>keys<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span>key <span class="hl opt">=&gt;</span> key<span class="hl opt">.</span>name<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>_keys_id<span class="hl opt">.</span>length <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwb">null</span><span class="hl opt">;</span>
      <span class="hl kwa">const</span> keys <span class="hl opt">=</span> _keys_id<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">async</span> key <span class="hl opt">=&gt;</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>KEYS_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>key<span class="hl opt">));</span>
      <span class="hl kwa">return await</span> keys<span class="hl opt">[</span>keys<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">type</span> <span class="hl opt">===</span> <span class="hl sng">&#39;ledgerKey&#39;</span><span class="hl opt">) {</span>
      <span class="hl kwa">return await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>KEYS_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl kwa">type</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>KEYS_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">+</span> <span class="hl sng">&#39;_&#39;</span> <span class="hl opt">+</span> <span class="hl kwa">type</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">postPubKey</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;postPubKey is deprecated&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">)</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">handleRoomCapacityChange</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> <span class="hl opt">{</span> searchParams <span class="hl opt">} =</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> newLimit <span class="hl opt">=</span> searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;capacity&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span>newLimit<span class="hl opt">) ||</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;room_capacity&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity<span class="hl opt">)</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> capacity<span class="hl opt">:</span> newLimit <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getRoomCapacity</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> capacity<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getOwnerUnreadMessages</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> unreadMessages<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>ownerUnread <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getPubKeys</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> keys<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>visitors <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">acceptVisitor</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> data <span class="hl opt">=</span> <span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">json</span><span class="hl opt">();</span>
    <span class="hl kwa">const</span> acceptPubKey<span class="hl opt">:</span> JsonWebKey <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">((</span>data <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span>pubKey<span class="hl opt">,</span> <span class="hl sng">&#39;L783&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> ind <span class="hl opt">=</span> sbCrypto<span class="hl opt">.</span><span class="hl kwd">lookupKey</span><span class="hl opt">(</span>acceptPubKey<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ind <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests <span class="hl opt">= [...</span><span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">, ...</span><span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>ind<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">)];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys<span class="hl opt">[(</span>data <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span>pubKey<span class="hl opt">] = (</span>data <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span>lockedKey<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;accepted_requests&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">));</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;lockedKeys&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;join_requests&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">))</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Could not accept visitor (visitor not found)&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">)</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">lockRoom</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>locked <span class="hl opt">=</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">let</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++)</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">.</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">[</span>i<span class="hl opt">]) &lt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">.</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">[</span>i<span class="hl opt">]) &lt;</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">[</span>i<span class="hl opt">]);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;join_requests&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">));</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;locked&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>locked<span class="hl opt">)</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> locked<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>locked <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getJoinRequests</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> join_requests<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">isRoomLocked</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> locked<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>locked <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">setMOTD</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> data <span class="hl opt">=</span> <span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">json</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>motd <span class="hl opt">= (</span>data <span class="hl kwa">as</span> <span class="hl kwb">any</span><span class="hl opt">).</span>motd<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;motd&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motd<span class="hl opt">);</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> motd<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motd <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">ownerKeyRotation</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ALLOW_OWNER_KEY_ROTATION<span class="hl opt">) {</span>
      <span class="hl kwa">let</span> _tries <span class="hl opt">=</span> <span class="hl num">3</span><span class="hl opt">;</span>
      <span class="hl kwa">let</span> _timeout <span class="hl opt">=</span> <span class="hl num">10000</span><span class="hl opt">;</span>
      <span class="hl kwa">let</span> _success <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">checkRotation</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>_success<span class="hl opt">) {</span>
        <span class="hl kwa">while</span> <span class="hl opt">(</span>_tries <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          _tries <span class="hl opt">-=</span> <span class="hl num">1</span><span class="hl opt">;</span>
          _success <span class="hl opt">=</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">checkRotation</span><span class="hl opt">(</span>_timeout<span class="hl opt">)</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>_success<span class="hl opt">) {</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
          <span class="hl opt">}</span>
          _timeout <span class="hl opt">*=</span> <span class="hl num">2</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>_success<span class="hl opt">) {</span>
          <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> success<span class="hl opt">:</span> <span class="hl kwb">false</span> <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">const</span> _updatedKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_owner<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>#<span class="hl kwd">broadcast</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> control<span class="hl opt">:</span> <span class="hl kwb">true</span><span class="hl opt">,</span> ownerKeyChanged<span class="hl opt">:</span> <span class="hl kwb">true</span><span class="hl opt">,</span> ownerKey<span class="hl opt">:</span> _updatedKey <span class="hl opt">}));</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>room_owner <span class="hl opt">=</span> _updatedKey<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests <span class="hl opt">= [...</span><span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">, ...</span><span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests <span class="hl opt">= [];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys <span class="hl opt">= [];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;join_requests&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">))</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;lockedKeys&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys<span class="hl opt">))</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;accepted_requests&#39;</span><span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">));</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> success<span class="hl opt">:</span> <span class="hl kwb">true</span> <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Owner key rotation not allowed&quot;</span><span class="hl opt">,</span> <span class="hl num">405</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">checkRotation</span><span class="hl opt">(</span>_timeout<span class="hl opt">:</span> <span class="hl kwb">number</span><span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span><span class="hl kwb">boolean</span><span class="hl opt">&gt; {</span>
    <span class="hl kwa">await new</span> <span class="hl kwd">Promise</span><span class="hl opt">((</span>resolve<span class="hl opt">) =&gt;</span> <span class="hl kwd">setTimeout</span><span class="hl opt">(</span>
      <span class="hl opt">() =&gt; {</span>
        <span class="hl kwd">resolve</span><span class="hl opt">(</span><span class="hl kwb">true</span><span class="hl opt">);</span>
      <span class="hl opt">},</span> _timeout<span class="hl opt">));</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwb">true</span><span class="hl opt">)</span>
  <span class="hl opt">}</span>
  #<span class="hl kwd">roundSize</span><span class="hl opt">(</span>size<span class="hl opt">:</span> <span class="hl kwb">number</span><span class="hl opt">,</span> roundUp <span class="hl opt">=</span> <span class="hl kwb">true</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>size <span class="hl opt">===</span> <span class="hl kwb">Infinity</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwb">Infinity</span><span class="hl opt">;</span> <span class="hl slc">// special case</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>size <span class="hl opt">&lt;=</span> STORAGE_SIZE_MIN<span class="hl opt">)</span> size <span class="hl opt">=</span> STORAGE_SIZE_MIN<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>size <span class="hl opt">&gt; (</span><span class="hl num">2</span> <span class="hl opt">**</span> <span class="hl num">52</span><span class="hl opt">))</span> <span class="hl kwa">throw new Error</span><span class="hl opt">(</span><span class="hl sng">`Storage size too large (max 2^52 and we got</span> <span class="hl ipl">${size}</span><span class="hl sng">)`</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> exp1 <span class="hl opt">=</span> <span class="hl kwb">Math</span><span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span><span class="hl kwb">Math</span><span class="hl opt">.</span><span class="hl kwd">log2</span><span class="hl opt">(</span>size<span class="hl opt">));</span>
    <span class="hl kwa">const</span> exp2 <span class="hl opt">=</span> exp1 <span class="hl opt">-</span> <span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl kwa">const</span> frac <span class="hl opt">=</span> <span class="hl kwb">Math</span><span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span>size <span class="hl opt">/ (</span><span class="hl num">2</span> <span class="hl opt">**</span> exp2<span class="hl opt">));</span>
    <span class="hl kwa">const</span> result <span class="hl opt">=</span> frac <span class="hl opt">&lt;&lt;</span> exp2<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>size <span class="hl opt">&gt;</span> result<span class="hl opt">) &amp;&amp;</span> roundUp<span class="hl opt">)</span> <span class="hl kwa">return</span> result <span class="hl opt">+ (</span><span class="hl num">2</span> <span class="hl opt">**</span> exp2<span class="hl opt">);</span>
    <span class="hl kwa">else return</span> result<span class="hl opt">;</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">handleNewStorage</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> <span class="hl opt">{</span> searchParams <span class="hl opt">} =</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> size <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#<span class="hl kwd">roundSize</span><span class="hl opt">(</span><span class="hl kwb">Number</span><span class="hl opt">(</span>searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;size&#39;</span><span class="hl opt">)));</span>
    <span class="hl kwa">const</span> storageLimit <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>size <span class="hl opt">&gt;</span> storageLimit<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&#39;Not sufficient storage budget left in channel&#39;</span><span class="hl opt">,</span> <span class="hl num">507</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>size <span class="hl opt">&gt;</span> STORAGE_SIZE_MAX<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`Storage size too large (max</span> <span class="hl ipl">${STORAGE_SIZE_MAX}</span> <span class="hl sng">bytes)`</span><span class="hl opt">,</span> <span class="hl num">413</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">=</span> storageLimit <span class="hl opt">-</span> size<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;storageLimit&#39;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">);</span>
    <span class="hl kwa">const</span> token_buffer <span class="hl opt">=</span> crypto<span class="hl opt">.</span><span class="hl kwd">getRandomValues</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">Uint8Array</span><span class="hl opt">(</span><span class="hl num">48</span><span class="hl opt">)).</span>buffer<span class="hl opt">;</span>
    <span class="hl kwa">const</span> token_hash_buffer <span class="hl opt">=</span> <span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">digest</span><span class="hl opt">(</span><span class="hl sng">&#39;SHA-256&#39;</span><span class="hl opt">,</span> token_buffer<span class="hl opt">)</span>
    <span class="hl kwa">const</span> token_hash <span class="hl opt">=</span> <span class="hl kwd">arrayBufferToBase64</span><span class="hl opt">(</span>token_hash_buffer<span class="hl opt">);</span>
    <span class="hl kwa">const</span> kv_data <span class="hl opt">= {</span> used<span class="hl opt">:</span> <span class="hl kwb">false</span><span class="hl opt">,</span> size<span class="hl opt">:</span> size <span class="hl opt">};</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>LEDGER_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>token_hash<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>kv_data<span class="hl opt">));</span>
    <span class="hl kwa">const</span> encrypted_token_id <span class="hl opt">=</span> <span class="hl kwd">arrayBufferToBase64</span><span class="hl opt">(</span><span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">encrypt</span><span class="hl opt">({</span> name<span class="hl opt">:</span> <span class="hl sng">&quot;RSA-OAEP&quot;</span> <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">.</span>ledgerKey<span class="hl opt">!,</span> token_buffer<span class="hl opt">));</span>
    <span class="hl kwa">const</span> hashed_room_id <span class="hl opt">=</span> <span class="hl kwd">arrayBufferToBase64</span><span class="hl opt">(</span><span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">digest</span><span class="hl opt">(</span><span class="hl sng">&#39;SHA-256&#39;</span><span class="hl opt">, (</span><span class="hl kwa">new</span> TextEncoder<span class="hl opt">).</span><span class="hl kwd">encode</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">)));</span>
    <span class="hl kwa">const</span> token <span class="hl opt">= {</span> token_hash<span class="hl opt">:</span> token_hash<span class="hl opt">,</span> hashed_room_id<span class="hl opt">:</span> hashed_room_id<span class="hl opt">,</span> encrypted_token_id<span class="hl opt">:</span> encrypted_token_id <span class="hl opt">};</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>token<span class="hl opt">),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getStorageLimit</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> storageLimit<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getMother</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> motherChannel<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motherChannel <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  
  <span class="hl kwa">async</span> #<span class="hl kwd">handleBuddRequest</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span>Response<span class="hl opt">&gt; {</span>
    <span class="hl kwa">const</span> _secret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>SERVER_SECRET<span class="hl opt">;</span>
    <span class="hl kwa">const</span> <span class="hl opt">{</span> searchParams <span class="hl opt">} =</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> targetChannel <span class="hl opt">=</span> searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;targetChannel&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">let</span> transferBudget <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#<span class="hl kwd">roundSize</span><span class="hl opt">(</span><span class="hl kwb">Number</span><span class="hl opt">(</span>searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;transferBudget&#39;</span><span class="hl opt">)));</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>targetChannel<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&#39;[budd()]: No target channel specified&#39;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">!==</span> targetChannel<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`[budd()]: Mother channel (</span><span class="hl ipl">${this.room_id.slice(0, 12)}</span><span class="hl sng">...) either does not exist, or has not been initialized, or lacks storage budget`</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">((!</span>transferBudget<span class="hl opt">) || (</span>transferBudget <span class="hl opt">===</span> <span class="hl kwb">Infinity</span><span class="hl opt">))</span> transferBudget <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">;</span> <span class="hl slc">// strip it</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>transferBudget <span class="hl opt">&gt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&#39;[budd()]: Not enough storage budget in mother channel for request&#39;</span><span class="hl opt">,</span> <span class="hl num">507</span><span class="hl opt">);</span>
      <span class="hl kwa">const</span> size <span class="hl opt">=</span> transferBudget
      <span class="hl kwa">const</span> newStorageLimit <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">-</span> size<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">=</span> newStorageLimit<span class="hl opt">;</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&#39;storageLimit&#39;</span><span class="hl opt">,</span> newStorageLimit<span class="hl opt">);</span>
      <span class="hl kwa">const</span> data <span class="hl opt">=</span> <span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">arrayBuffer</span><span class="hl opt">();</span>
      <span class="hl kwa">const</span> jsonString <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TextDecoder</span><span class="hl opt">().</span><span class="hl kwd">decode</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
      <span class="hl kwa">let</span> jsonData <span class="hl opt">=</span> jsonString <span class="hl opt">?</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>jsonString<span class="hl opt">,</span> <span class="hl sng">&#39;L1018&#39;</span><span class="hl opt">) : {};</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>jsonData<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">))</span> <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`[budd()]: SERVER_SECRET set? Huh?`</span><span class="hl opt">,</span> <span class="hl num">403</span><span class="hl opt">);</span>
      jsonData<span class="hl opt">[</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">] =</span> _secret<span class="hl opt">;</span> <span class="hl slc">// we are authorizing this creation/transfer</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>size <span class="hl opt">&lt;</span> NEW_CHANNEL_MINIMUM_BUDGET<span class="hl opt">)</span>
        <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`Not enough storage request for a new channel (minimum is</span> <span class="hl ipl">${NEW_CHANNEL_MINIMUM_BUDGET}</span> <span class="hl sng">bytes)`</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
      jsonData<span class="hl opt">[</span><span class="hl sng">&quot;size&quot;</span><span class="hl opt">] =</span> size<span class="hl opt">;</span>
      jsonData<span class="hl opt">[</span><span class="hl sng">&quot;motherChannel&quot;</span><span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">;</span> <span class="hl slc">// we leave a birth certificate behind</span>
      <span class="hl kwa">const</span> newUrl <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
      newUrl<span class="hl opt">.</span>pathname <span class="hl opt">=</span> <span class="hl sng">`/api/room/</span><span class="hl ipl">${targetChannel}</span><span class="hl sng">/uploadRoom`</span><span class="hl opt">;</span>
      <span class="hl kwa">const</span> newRequest <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Request</span><span class="hl opt">(</span>newUrl<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(), {</span>
        method<span class="hl opt">:</span> <span class="hl sng">&#39;POST&#39;</span><span class="hl opt">,</span>
        body<span class="hl opt">:</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>jsonData<span class="hl opt">),</span>
        headers<span class="hl opt">: {</span>
          <span class="hl sng">&#39;Content-Type&#39;</span><span class="hl opt">:</span> <span class="hl sng">&#39;application/json&#39;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">});</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>LEDGER_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>targetChannel<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> mother<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">,</span> size<span class="hl opt">:</span> size <span class="hl opt">}));</span>
      <span class="hl kwa">return</span> <span class="hl kwd">callDurableObject</span><span class="hl opt">(</span>targetChannel<span class="hl opt">, [</span><span class="hl sng">&#39;uploadRoom&#39;</span><span class="hl opt">],</span> newRequest<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">)</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&#39;[budd()]: ERROR - this should not happen [L1060]&#39;</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">handleAdminDataRequest</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> adminData<span class="hl opt">:</span> ChannelAdminData <span class="hl opt">= {</span>
      room_id<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">,</span>
      join_requests<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">,</span>
      capacity<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity<span class="hl opt">,</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>adminData<span class="hl opt">),</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">verifySign</span><span class="hl opt">(</span>secretKey<span class="hl opt">:</span> CryptoKey<span class="hl opt">,</span> sign<span class="hl opt">:</span> <span class="hl kwb">any</span><span class="hl opt">,</span> contents<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">) {</span>
    <span class="hl kwa">const</span> _sign <span class="hl opt">=</span> <span class="hl kwd">base64ToArrayBuffer</span><span class="hl opt">(</span><span class="hl kwd">decodeURIComponent</span><span class="hl opt">(</span>sign<span class="hl opt">));</span>
    <span class="hl kwa">const</span> encoder <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TextEncoder</span><span class="hl opt">();</span>
    <span class="hl kwa">const</span> encoded <span class="hl opt">=</span> encoder<span class="hl opt">.</span><span class="hl kwd">encode</span><span class="hl opt">(</span>contents<span class="hl opt">);</span>
    <span class="hl kwa">const</span> verified <span class="hl opt">=</span> <span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">verify</span><span class="hl opt">(</span>
      <span class="hl opt">{</span> name<span class="hl opt">:</span> <span class="hl sng">&#39;ECDSA&#39;</span><span class="hl opt">,</span> hash<span class="hl opt">:</span> <span class="hl sng">&#39;SHA-256&#39;</span> <span class="hl opt">},</span>
      secretKey<span class="hl opt">,</span>
      _sign<span class="hl opt">,</span>
      encoded
    <span class="hl opt">);</span>
    <span class="hl kwa">return</span> verified<span class="hl opt">;</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">verifyCookie</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> cookies<span class="hl opt">:</span> <span class="hl kwb">any</span> <span class="hl opt">= {};</span>
    request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">has</span><span class="hl opt">(</span><span class="hl sng">&#39;cookie&#39;</span><span class="hl opt">) &amp;&amp;</span> request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;cookie&#39;</span><span class="hl opt">)!.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl sng">&#39;;&#39;</span><span class="hl opt">).</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl opt">(</span>cookie<span class="hl opt">) {</span>
      <span class="hl kwa">const</span> parts <span class="hl opt">=</span> cookie<span class="hl opt">.</span><span class="hl kwd">match</span><span class="hl opt">(/(.*?)=(.*)</span>$<span class="hl opt">/)</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>parts<span class="hl opt">)</span>
        cookies<span class="hl opt">[</span>parts<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">].</span><span class="hl kwd">trim</span><span class="hl opt">()] = (</span>parts<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] ||</span> <span class="hl sng">&#39;&#39;</span><span class="hl opt">).</span><span class="hl kwd">trim</span><span class="hl opt">();</span>
    <span class="hl opt">});</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>cookies<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span><span class="hl sng">&#39;token_&#39;</span> <span class="hl opt">+</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">)) {</span>
      <span class="hl kwa">return</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">const</span> verificationKey <span class="hl opt">=</span> <span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">importKey</span><span class="hl opt">(</span><span class="hl sng">&quot;jwk&quot;</span><span class="hl opt">,</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>KEYS_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_id <span class="hl opt">+</span> <span class="hl sng">&#39;_authorizationKey&#39;</span><span class="hl opt">),</span> <span class="hl sng">&#39;L778&#39;</span><span class="hl opt">), {</span>
      name<span class="hl opt">:</span> <span class="hl sng">&quot;ECDSA&quot;</span><span class="hl opt">,</span>
      namedCurve<span class="hl opt">:</span> <span class="hl sng">&quot;P-384&quot;</span>
    <span class="hl opt">},</span> <span class="hl kwb">false</span><span class="hl opt">, [</span><span class="hl sng">&#39;verify&#39;</span><span class="hl opt">]);</span>
    <span class="hl kwa">const</span> auth_parts <span class="hl opt">=</span> cookies<span class="hl opt">[</span><span class="hl sng">&#39;token_&#39;</span> <span class="hl opt">+</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">].</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl sng">&#39;.&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> payload <span class="hl opt">=</span> auth_parts<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    <span class="hl kwa">const</span> sign <span class="hl opt">=</span> auth_parts<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">];</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">verifySign</span><span class="hl opt">(</span>verificationKey<span class="hl opt">,</span> sign<span class="hl opt">,</span> payload <span class="hl opt">+</span> <span class="hl sng">&#39;_&#39;</span> <span class="hl opt">+</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">) &amp;&amp; ((</span><span class="hl kwa">new</span> <span class="hl kwb">Date</span><span class="hl opt">()).</span><span class="hl kwd">getTime</span><span class="hl opt">() -</span> <span class="hl kwd">parseInt</span><span class="hl opt">(</span>payload<span class="hl opt">)) &lt;</span> <span class="hl num">86400000</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">verifyAuthSign</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span><span class="hl kwb">boolean</span><span class="hl opt">&gt; {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">const</span> authHeader <span class="hl opt">=</span> request<span class="hl opt">.</span>headers<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;authorization&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>authHeader<span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">const</span> auth_parts <span class="hl opt">=</span> authHeader<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl sng">&#39;.&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwb">Date</span><span class="hl opt">().</span><span class="hl kwd">getTime</span><span class="hl opt">() -</span> <span class="hl kwd">parseInt</span><span class="hl opt">(</span>auth_parts<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]) &gt;</span> <span class="hl num">60000</span><span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl kwb">false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">const</span> sign <span class="hl opt">=</span> auth_parts<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">];</span>
    <span class="hl kwa">const</span> ownerKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">!.</span>ownerKey
    <span class="hl kwa">const</span> roomSignKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">!.</span>signKey
    <span class="hl kwa">const</span> verificationKey <span class="hl opt">=</span> <span class="hl kwa">await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">deriveKey</span><span class="hl opt">(</span>
      <span class="hl opt">{</span>
        name<span class="hl opt">:</span> <span class="hl sng">&quot;ECDH&quot;</span><span class="hl opt">,</span>
        <span class="hl kwa">public</span><span class="hl opt">:</span> ownerKey  <span class="hl slc">// looks like possible issues with cloudflare worker types?</span>
      <span class="hl opt">},</span>
      roomSignKey<span class="hl opt">,</span>
      <span class="hl opt">{</span>
        name<span class="hl opt">:</span> <span class="hl sng">&quot;HMAC&quot;</span><span class="hl opt">,</span>
        hash<span class="hl opt">:</span> <span class="hl sng">&quot;SHA-256&quot;</span><span class="hl opt">,</span>
        length<span class="hl opt">:</span> <span class="hl num">256</span>
      <span class="hl opt">},</span>
      <span class="hl kwb">false</span><span class="hl opt">,</span>
      <span class="hl opt">[</span><span class="hl sng">&quot;verify&quot;</span><span class="hl opt">]);</span>
    <span class="hl kwa">return await</span> crypto<span class="hl opt">.</span>subtle<span class="hl opt">.</span><span class="hl kwd">verify</span><span class="hl opt">(</span><span class="hl sng">&quot;HMAC&quot;</span><span class="hl opt">,</span> verificationKey<span class="hl opt">,</span> <span class="hl kwd">base64ToArrayBuffer</span><span class="hl opt">(</span>sign<span class="hl opt">),</span> <span class="hl kwa">new</span> <span class="hl kwd">TextEncoder</span><span class="hl opt">().</span><span class="hl kwd">encode</span><span class="hl opt">(</span>auth_parts<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]));</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">verifyAuth</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span><span class="hl kwb">boolean</span><span class="hl opt">&gt; {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">verifyCookie</span><span class="hl opt">(</span>request<span class="hl opt">) ||</span> <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">verifyAuthSign</span><span class="hl opt">(</span>request<span class="hl opt">))</span>
  <span class="hl opt">}</span>
  #<span class="hl kwd">registerDevice</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;registerDevice is disabled, use web notifications&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">)</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">sendWebNotifications</span><span class="hl opt">(</span>message<span class="hl opt">:</span> <span class="hl kwb">string</span><span class="hl opt">) {</span>
    <span class="hl kwa">const</span> envNotifications <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>notifications
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>envNotifications<span class="hl opt">) {</span>
      <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    message <span class="hl opt">=</span> JSON<span class="hl opt">.</span><span class="hl kwd">parse</span><span class="hl opt">(</span>message<span class="hl opt">)</span>
    <span class="hl kwa">const</span> coeff <span class="hl opt">=</span> <span class="hl num">1000</span> <span class="hl opt">*</span> <span class="hl num">60</span> <span class="hl opt">*</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">const</span> date <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwb">Date</span><span class="hl opt">();</span>
    <span class="hl kwa">const</span> rounded <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwb">Date</span><span class="hl opt">(</span><span class="hl kwb">Math</span><span class="hl opt">.</span><span class="hl kwd">round</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getTime</span><span class="hl opt">() /</span> coeff<span class="hl opt">) *</span> coeff<span class="hl opt">)</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
      <span class="hl kwa">const</span> options <span class="hl opt">= {</span>
        method<span class="hl opt">:</span> <span class="hl sng">&quot;POST&quot;</span><span class="hl opt">,</span>
        body<span class="hl opt">:</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span>
          <span class="hl sng">&quot;channel_id&quot;</span><span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">,</span>
          <span class="hl sng">&quot;notification&quot;</span><span class="hl opt">: {</span>
            silent<span class="hl opt">:</span> <span class="hl kwb">false</span><span class="hl opt">,</span>
            tag<span class="hl opt">:</span> <span class="hl sng">`</span><span class="hl ipl">${this.room_id}${rounded}</span><span class="hl sng">`</span><span class="hl opt">,</span>
            title<span class="hl opt">:</span> <span class="hl sng">&quot;You have a new message!&quot;</span><span class="hl opt">,</span>
            vibration<span class="hl opt">: [</span><span class="hl num">100</span><span class="hl opt">,</span> <span class="hl num">50</span><span class="hl opt">,</span> <span class="hl num">100</span><span class="hl opt">,</span> <span class="hl num">50</span><span class="hl opt">,</span> <span class="hl num">350</span><span class="hl opt">],</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}),</span>
        headers<span class="hl opt">: {</span>
          <span class="hl sng">&quot;Content-Type&quot;</span><span class="hl opt">:</span> <span class="hl sng">&quot;application/json&quot;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return await</span> envNotifications<span class="hl opt">.</span><span class="hl kwd">fetch</span><span class="hl opt">(</span><span class="hl sng">&quot;https://notifications.384.dev/notify&quot;</span><span class="hl opt">,</span> options<span class="hl opt">)</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>err<span class="hl opt">) {</span>
      console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
      console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl sng">&quot;Error sending web notification&quot;</span><span class="hl opt">)</span>
      <span class="hl kwa">return</span> err
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">downloadAllData</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> data<span class="hl opt">:</span> <span class="hl kwb">any</span> <span class="hl opt">= {</span>
      roomId<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">,</span>
      ownerKey<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_owner<span class="hl opt">,</span>
      channelKeys<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">,</span>
      guestKey<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>verified_guest<span class="hl opt">,</span>
      locked<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>locked<span class="hl opt">,</span>
      motd<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motd<span class="hl opt">,</span>
    <span class="hl opt">};</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">verifyAuth</span><span class="hl opt">(</span>request<span class="hl opt">)) {</span>
      data<span class="hl opt">.</span>adminData <span class="hl opt">= {</span> join_requests<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>join_requests<span class="hl opt">,</span> capacity<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity <span class="hl opt">};</span>
      data<span class="hl opt">.</span>storageLimit <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">;</span>
      data<span class="hl opt">.</span>accepted_requests <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>accepted_requests<span class="hl opt">;</span>
      data<span class="hl opt">.</span>lockedKeys <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>lockedKeys<span class="hl opt">;</span>
      data<span class="hl opt">.</span>motherChannel <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>motherChannel<span class="hl opt">;</span>
      data<span class="hl opt">.</span>pubKeys <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>visitors<span class="hl opt">;</span>
      data<span class="hl opt">.</span>roomCapacity <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_capacity<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">const</span> dataBlob <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TextEncoder</span><span class="hl opt">().</span><span class="hl kwd">encode</span><span class="hl opt">(</span>JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>data<span class="hl opt">));</span>
    <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> dataBlob<span class="hl opt">,</span> <span class="hl num">200</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">createChannel</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">):</span> Promise<span class="hl opt">&lt;</span>Response <span class="hl opt">|</span> <span class="hl kwb">null</span><span class="hl opt">&gt; {</span>
    <span class="hl kwa">const</span> jsonString <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TextDecoder</span><span class="hl opt">().</span><span class="hl kwd">decode</span><span class="hl opt">(</span><span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">arrayBuffer</span><span class="hl opt">());</span>
    <span class="hl kwa">const</span> jsonData <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>jsonString<span class="hl opt">,</span> <span class="hl sng">&#39;L1128&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> url <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> path <span class="hl opt">=</span> url<span class="hl opt">.</span>pathname<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl sng">&#39;/&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span>jsonData<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">) ||</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">] ===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>SERVER_SECRET<span class="hl opt">))</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Not authorized to create channel&quot;</span><span class="hl opt">,</span> <span class="hl num">401</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> newOwnerKey <span class="hl opt">=</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;ownerKey&quot;</span><span class="hl opt">];</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>newOwnerKey<span class="hl opt">)</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;No owner key provided&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>room_owner <span class="hl opt">=</span> newOwnerKey<span class="hl opt">;</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&quot;room_owner&quot;</span><span class="hl opt">,</span> newOwnerKey<span class="hl opt">);</span> <span class="hl slc">// signals channel has been validly created</span>
    <span class="hl kwa">const</span> newOwnerKeyJson <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>newOwnerKey<span class="hl opt">,</span> <span class="hl sng">&#39;L1218&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">await</span> sbCrypto<span class="hl opt">.</span><span class="hl kwd">verifyChannelId</span><span class="hl opt">(</span>newOwnerKeyJson<span class="hl opt">,</span> path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">])))</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Owner key does not match channel id (validation of channel viz keys failed)&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">const</span> key <span class="hl kwa">of</span> <span class="hl opt">[</span><span class="hl sng">&quot;ownerKey&quot;</span><span class="hl opt">,</span> <span class="hl sng">&quot;encryptionKey&quot;</span><span class="hl opt">,</span> <span class="hl sng">&quot;signKey&quot;</span><span class="hl opt">,</span> <span class="hl sng">&quot;motherChannel&quot;</span><span class="hl opt">,</span> <span class="hl sng">&quot;visitors&quot;</span><span class="hl opt">]) {</span>
      <span class="hl kwa">const</span> newData <span class="hl opt">=</span> jsonData<span class="hl opt">[</span>key<span class="hl opt">];</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>newData<span class="hl opt">)</span>
        <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>key<span class="hl opt">,</span> newData<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&quot;personalRoom&quot;</span><span class="hl opt">,</span> <span class="hl sng">&#39;true&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&quot;storageLimit&quot;</span><span class="hl opt">,</span> <span class="hl kwb">Infinity</span><span class="hl opt">);</span>
    <span class="hl kwa">await this</span><span class="hl opt">.</span>#<span class="hl kwd">initialize</span><span class="hl opt">(</span>path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">])</span>
      <span class="hl opt">.</span><span class="hl kwa">catch</span><span class="hl opt">(</span>err <span class="hl opt">=&gt; {</span> <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">`Error initializing room [L1212]:</span> <span class="hl ipl">${err}</span><span class="hl sng">`</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">) });</span>
    <span class="hl kwa">return</span> <span class="hl kwb">null</span><span class="hl opt">;</span> <span class="hl slc">// null means no errors</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">getChannelKeys</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> data<span class="hl opt">:</span> <span class="hl kwb">any</span> <span class="hl opt">= {};</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">) {</span>
      data<span class="hl opt">.</span>ownerKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">.</span>ownerKey<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">.</span>guestKey<span class="hl opt">)</span>
        data<span class="hl opt">.</span>guestKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">.</span>guestKey<span class="hl opt">;</span>
      data<span class="hl opt">.</span>encryptionKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">!.</span>encryptionKey<span class="hl opt">;</span>
      data<span class="hl opt">.</span>signKey <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeyStrings<span class="hl opt">.</span>signKey<span class="hl opt">;</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>data<span class="hl opt">),</span> <span class="hl num">200</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Channel keys not initialized&quot;</span><span class="hl opt">,</span> <span class="hl num">500</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">uploadData</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>#channelKeys<span class="hl opt">)</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;UploadData but not initialized / created&quot;</span><span class="hl opt">,</span> <span class="hl num">400</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> _secret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>SERVER_SECRET<span class="hl opt">;</span>
    <span class="hl kwa">const</span> data <span class="hl opt">=</span> <span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">arrayBuffer</span><span class="hl opt">();</span>
    <span class="hl kwa">const</span> jsonString <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TextDecoder</span><span class="hl opt">().</span><span class="hl kwd">decode</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
    <span class="hl kwa">const</span> jsonData <span class="hl opt">=</span> <span class="hl kwd">jsonParseWrapper</span><span class="hl opt">(</span>jsonString<span class="hl opt">,</span> <span class="hl sng">&#39;L1416&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">const</span> requestAuthorized <span class="hl opt">=</span> jsonData<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">) ||</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">] ===</span> _secret<span class="hl opt">;</span>
    <span class="hl kwa">const</span> <span class="hl opt">{</span> searchParams <span class="hl opt">} =</span> <span class="hl kwa">new</span> <span class="hl kwd">URL</span><span class="hl opt">(</span>request<span class="hl opt">.</span>url<span class="hl opt">);</span>
    <span class="hl kwa">const</span> targetChannel <span class="hl opt">=</span> searchParams<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&#39;targetChannel&#39;</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>requestAuthorized<span class="hl opt">) &amp;&amp; (</span>jsonData<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span><span class="hl sng">&quot;size&quot;</span><span class="hl opt">)) &amp;&amp; (</span>targetChannel <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">)) {</span>
      <span class="hl kwa">const</span> size <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span>jsonData<span class="hl opt">[</span><span class="hl sng">&quot;size&quot;</span><span class="hl opt">]);</span>
      <span class="hl kwd">_sb_assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">!==</span> <span class="hl kwb">undefined</span><span class="hl opt">,</span> <span class="hl sng">&quot;storageLimit undefined&quot;</span><span class="hl opt">);</span>
      <span class="hl kwa">const</span> currentStorage <span class="hl opt">=</span> <span class="hl kwb">Number</span><span class="hl opt">(</span><span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl sng">&quot;storageLimit&quot;</span><span class="hl opt">));</span>
      <span class="hl kwd">_sb_assert</span><span class="hl opt">(</span>currentStorage <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">,</span> <span class="hl sng">&quot;storage out of whatck&quot;</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit <span class="hl opt">+=</span> size<span class="hl opt">;</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&quot;storageLimit&quot;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>storageLimit<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    
    <span class="hl kwa">if</span> <span class="hl opt">((</span><span class="hl kwa">this</span><span class="hl opt">.</span>room_owner <span class="hl opt">===</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;roomOwner&quot;</span><span class="hl opt">]) ||</span> requestAuthorized<span class="hl opt">) {</span>
      <span class="hl kwa">let</span> entriesBuffer<span class="hl opt">:</span> Record<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">,</span> <span class="hl kwb">string</span><span class="hl opt">&gt; = {};</span>
      <span class="hl kwa">let</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">const</span> key <span class="hl kwa">in</span> jsonData<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>key<span class="hl opt">.</span>length <span class="hl opt">!=</span> <span class="hl num">106</span><span class="hl opt">) {</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>key<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">64</span><span class="hl opt">) ===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>room_id<span class="hl opt">) {</span>
          <span class="hl kwa">const</span> _key <span class="hl opt">=</span> key<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">64</span><span class="hl opt">,</span> <span class="hl num">106</span><span class="hl opt">);</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>_key<span class="hl opt">.</span><span class="hl kwd">match</span><span class="hl opt">(/^[</span><span class="hl num">01</span><span class="hl opt">]+</span>$<span class="hl opt">/)) {</span>
            <span class="hl kwa">const</span> newData <span class="hl opt">=</span> jsonData<span class="hl opt">[</span>key<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>newData<span class="hl opt">) {</span>
              entriesBuffer<span class="hl opt">[</span>key<span class="hl opt">] =</span> newData<span class="hl opt">;</span>
              <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>MESSAGES_NAMESPACE<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>key<span class="hl opt">,</span> newData<span class="hl opt">);</span>
              i <span class="hl opt">+=</span> <span class="hl num">1</span><span class="hl opt">;</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;</span> <span class="hl num">100</span><span class="hl opt">) {</span>
                <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>entriesBuffer<span class="hl opt">);</span>
                entriesBuffer <span class="hl opt">= {};</span>
                i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
              <span class="hl opt">}</span>
            <span class="hl opt">}</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>entriesBuffer<span class="hl opt">);</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> success<span class="hl opt">:</span> <span class="hl kwb">true</span> <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Not authorized (neither owner keys nor admin credentials)&quot;</span><span class="hl opt">,</span> <span class="hl num">401</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">async</span> #<span class="hl kwd">authorizeRoom</span><span class="hl opt">(</span>request<span class="hl opt">:</span> Request<span class="hl opt">) {</span>
    <span class="hl kwa">const</span> _secret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>env<span class="hl opt">.</span>SERVER_SECRET<span class="hl opt">;</span>
    <span class="hl kwa">const</span> jsonData<span class="hl opt">:</span> <span class="hl kwb">any</span> <span class="hl opt">=</span> <span class="hl kwa">await</span> request<span class="hl opt">.</span><span class="hl kwd">json</span><span class="hl opt">();</span>
    <span class="hl kwa">const</span> requestAuthorized <span class="hl opt">=</span> jsonData<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">) &amp;&amp;</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;SERVER_SECRET&quot;</span><span class="hl opt">] ===</span> _secret<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>requestAuthorized<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>personalRoom <span class="hl opt">=</span> <span class="hl kwb">true</span><span class="hl opt">;</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&quot;personalRoom&quot;</span><span class="hl opt">,</span> <span class="hl sng">&#39;true&#39;</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>room_owner <span class="hl opt">=</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;room_owner&quot;</span><span class="hl opt">];</span>
      <span class="hl kwa">await this</span><span class="hl opt">.</span>storage<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl sng">&quot;room_owner&quot;</span><span class="hl opt">,</span> jsonData<span class="hl opt">[</span><span class="hl sng">&quot;ownerKey&quot;</span><span class="hl opt">]);</span>
      <span class="hl kwa">return</span> <span class="hl kwd">returnResult</span><span class="hl opt">(</span>request<span class="hl opt">,</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">({</span> success<span class="hl opt">:</span> <span class="hl kwb">true</span> <span class="hl opt">}),</span> <span class="hl num">200</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else return</span> <span class="hl kwd">returnError</span><span class="hl opt">(</span>request<span class="hl opt">,</span> <span class="hl sng">&quot;Cannot authorize room: server secret did not match&quot;</span><span class="hl opt">,</span> <span class="hl num">401</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 4.5, http://www.andre-simon.de/-->
